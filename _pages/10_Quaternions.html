
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lab 10: Quaternions &#8212; Computer Graphics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex": {"macros": {"vec": ["\\mathbf{#1}", 1]}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_pages/10_Quaternions';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Lab 9: Normal Mapping" href="09_Normal_mapping.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Computer Graphics - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Computer Graphics - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Contents
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preliminaries</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="P_Core_concepts.html">Core Computer Graphics Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="P_Software.html">Visual Studio Code</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Labs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_intro_to_javascript.html">Lab 1: Introduction to JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Basic_shapes.html">Lab 2: Drawing Basic Shapes in WebGL</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Textures.html">Lab 3: Textures</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_Vectors_and_matrices.html">Lab 4: Vectors and Matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_Transformations.html">Lab 5: Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_3D_worlds.html">Lab 6: 3D Worlds</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_Moving_the_camera.html">Lab 7: Moving the Camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_Lighting.html">Lab 8: Lighting</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_Normal_mapping.html">Lab 9: Normal Mapping</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lab 10: Quaternions</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/jonshiach/graphics-notes" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jonshiach/graphics-notes/issues/new?title=Issue%20on%20page%20%2F_pages/10_Quaternions.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/_pages/10_Quaternions.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lab 10: Quaternions</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#complex-numbers">Complex Numbers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rotation-using-complex-numbers">Rotation using complex numbers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quaternions">Quaternions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quaternion-magnitude">Quaternion magnitude</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unit-quaternion">Unit quaternion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiplying-quaternions">Multiplying quaternions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quaternion-inverse">Quaternion inverse</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rotations-using-quaternions">Rotations using quaternions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#matrix-representation-of-a-quaternion">Matrix representation of a quaternion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-quaternion-camera">A Quaternion camera</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slerp">SLERP</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#third-person-camera">Third person camera</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#video-walkthrough">Video walkthrough</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lab-10-quaternions">
<span id="quaternions-section"></span><h1>Lab 10: Quaternions<a class="headerlink" href="#lab-10-quaternions" title="Link to this heading">#</a></h1>
<p>We saw in <a class="reference internal" href="05_Transformations.html#axis-angle-rotation-section"><span class="std std-ref">Lab 5: Transformations</span></a> that we can calculate a transformation matrix to rotate about a vector. This matrix was derived by compositing three individual rotations about the three co-ordinate <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(z\)</span> axes.</p>
<figure class="align-default" id="euler-angles-figure">
<a class="reference internal image-reference" href="../_images/10_Euler_angles.svg"><img alt="../_images/10_Euler_angles.svg" src="../_images/10_Euler_angles.svg" style="width: 300px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 105 </span><span class="caption-text">The pitch, yaw and roll Euler angles.</span><a class="headerlink" href="#euler-angles-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The angles that we use to define the rotation around each of the axes are known as <strong>Euler angles</strong> and we use the names <strong>pitch</strong>, <strong>yaw</strong> and <strong>roll</strong> for the rotation around the <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(z\)</span> axes respectively. The problem with using a composite of Euler angles rotations is that for certain alignments we can experience <a href="https://en.wikipedia.org/wiki/Gimbal_lock" target="_blank"><strong>gimbal lock</strong></a> where two of the rotation axes are aligned leading to a loss of a degree of freedom causing the composite rotation to be <em>locked</em> into a 2D rotation.</p>
<p>Quaternions are a mathematical object that can be used to perform rotation operations that do not suffer from gimbal lock and require fewer floating point calculations. There is quite a lot of maths used here but in this page I’ve focussed only on the bits you need to know to apply quaternions.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Create a copy of either your folders from labs 7, 8 or 9 (doesn’t matter which one, as long is it has a working camera that can be controlled using a keyboard and mouse), rename it <em><strong>Lab 10 Quaternions</strong></em>, rename the main JavaScript file to <em><strong>quaternions.js</strong></em> and change <em><strong>index.html</strong></em> so that the page title is “Lab 10 - Quaternions”.</p>
<p>Then create a new file called <em><strong>quaternion_calculations.js</strong></em> and enter the following</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">setupConsoleOutput</span><span class="p">(</span><span class="nx">elementId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">elementId</span><span class="p">);</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">write</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">line</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">args</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">output</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">write</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">setupConsoleOutput</span><span class="p">(</span><span class="s2">&quot;console-output&quot;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Lab 10 - Quaternions\n--------------------&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, create a new file called <em><strong>index2.html</strong></em> and enter the following</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;!doctype html&gt;</span>

<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Lab 10 - Quaternions<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;console-output&quot;</span> 
         <span class="na">style</span><span class="o">=</span><span class="s">&quot;font-family:monospace; white-space: pre; padding:10px;&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;maths.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;quaternion_calculations.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<p>In this lab we will being by learning how to perform calculations using quaternions the <em><strong>quaternion_calculations.js</strong></em> file and adding a class to the <em><strong>maths.js</strong></em> file. Once we know our class performs the correct calculations, we will implement this into the <em><strong>quaternions.js</strong></em> and <em><strong>camera.js</strong></em> files. Load <em><strong>index2.html</strong></em> in a live server and you should see a webpage containing the following</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Lab 10 - Quaternions
--------------------
</pre></div>
</div>
<hr class="docutils" />
<section id="complex-numbers">
<h2>Complex Numbers<a class="headerlink" href="#complex-numbers" title="Link to this heading">#</a></h2>
<p>Before we delve into quaternions we must first look at complex numbers. Consider the following equation</p>
<div class="math notranslate nohighlight">
\[ x^2 + 1 = 0. \]</div>
<p>Solving using simple algebra gives</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    x^2 + 1 &amp;= 0 \\
    x^2 &amp;= -1 \\
    x &amp;= \sqrt{-1}.
\end{align*} \end{split}\]</div>
<p>Here we have a problem since the square of a negative number always returns a positive value, e.g., <span class="math notranslate nohighlight">\((-1) \times (-1) = 1\)</span>, so there does not exist a real number to satisfy the solution to this equation. Not being satisfied with this, mathematicians invented another type of number called the <strong>imaginary number</strong> that is defined by <span class="math notranslate nohighlight">\(i = \sqrt{-1}\)</span> so the solution to the equation above is <span class="math notranslate nohighlight">\(x = i\)</span>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some students find the concept of an imaginary number difficult to grasp. However, you have been using negative numbers for a while now and these are similar to the imaginary number since they do not represent a physical quantity, e.g., you can show me 5 coins but you cannot show me negative 5 coins. We developed negative numbers to help us solve problems, as we have also done with the imaginary number.</p>
</div>
<p>Imaginary numbers can be combined with real numbers to give us a <strong>complex number</strong> where a real number is added to a multiple of the imaginary number</p>
<div class="math notranslate nohighlight">
\[ z = x + yi, \]</div>
<p>where <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are real numbers, <span class="math notranslate nohighlight">\(x\)</span> is known as the <strong>real part</strong> and <span class="math notranslate nohighlight">\(y\)</span> is known as the <strong>imaginary part</strong> of a complex number.</p>
<p>Since a complex number consists of two parts we can plot them on a 2D space called the <strong>complex plane</strong> where the horizontal axis is used to represent the real part and the vertical axis is used to represent the imaginary part (<a class="reference internal" href="#complex-plane-figure"><span class="std std-numref">Fig. 106</span></a>).</p>
<figure class="align-default" id="complex-plane-figure">
<a class="reference internal image-reference" href="../_images/10_Complex_plane.svg"><img alt="../_images/10_Complex_plane.svg" src="../_images/10_Complex_plane.svg" style="width: 400px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 106 </span><span class="caption-text">The complex number <span class="math notranslate nohighlight">\(z = x + yi\)</span> plotted on the complex plane.</span><a class="headerlink" href="#complex-plane-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>We can see from <a class="reference internal" href="#complex-plane-figure"><span class="std std-numref">Fig. 106</span></a> that a complex number <span class="math notranslate nohighlight">\(z = x + yi\)</span> can be thought of as a 2D vector pointing from <span class="math notranslate nohighlight">\((0,0)\)</span> to <span class="math notranslate nohighlight">\((x, y)\)</span>. The length of this vector is known as the <strong>magnitude</strong> of <span class="math notranslate nohighlight">\(z\)</span> denoted by <span class="math notranslate nohighlight">\(|z|\)</span> and calculated using</p>
<div class="math notranslate nohighlight">
\[|z| = \sqrt{x^2 + y^2}.\]</div>
<section id="rotation-using-complex-numbers">
<h3>Rotation using complex numbers<a class="headerlink" href="#rotation-using-complex-numbers" title="Link to this heading">#</a></h3>
<p>A very useful property of complex numbers, and the reason why we are interested in them, is that multiplying a number by <span class="math notranslate nohighlight">\(i\)</span> rotates the number by <span class="math notranslate nohighlight">\(90^\circ\)</span> in the complex plane. For example consider the complex number <span class="math notranslate nohighlight">\(2 + i\)</span>, multiplying repeatedly by <span class="math notranslate nohighlight">\(i\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    (2 + i)i &amp;= 2i + i^2 = -1 + 2i, \\
    (-1 +2i)i &amp;= -i + 2i^2 = -2 - i, \\
    (-2 - i)i &amp;= -2i - i^2 = 1 - 2i, \\
    (1 - 2i)i &amp;= i - 2i^2 = 2 + i.
\end{align*} \end{split}\]</div>
<p>So after mulitplying <span class="math notranslate nohighlight">\(2 + i\)</span> by <span class="math notranslate nohighlight">\(i\)</span> four times we are back to where we started. <a class="reference internal" href="#complex-rotation-figure"><span class="std std-numref">Fig. 107</span></a> shows these complex numbers plotted on the complex plane. Note how they have been rotated by <span class="math notranslate nohighlight">\(90^\circ\)</span> each time.</p>
<figure class="align-default" id="complex-rotation-figure">
<a class="reference internal image-reference" href="../_images/10_Complex_rotation.svg"><img alt="../_images/10_Complex_rotation.svg" src="../_images/10_Complex_rotation.svg" style="width: 300px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 107 </span><span class="caption-text">Rotation of the complex number <span class="math notranslate nohighlight">\(2 + i\)</span> by repeated multiplying by <span class="math notranslate nohighlight">\(i\)</span>.</span><a class="headerlink" href="#complex-rotation-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>So we have seen that multiplying a number by <span class="math notranslate nohighlight">\(i\)</span> rotates it by 90<span class="math notranslate nohighlight">\(^\circ\)</span>, so how do we rotate a number by a different angle? <a class="reference internal" href="#complex-rotation-2-figure"><span class="std std-numref">Fig. 108</span></a> shows the rotation of the number 1 by <span class="math notranslate nohighlight">\(\theta\)</span> anti-clockwise in the complex plane.</p>
<figure class="align-default" id="complex-rotation-2-figure">
<a class="reference internal image-reference" href="../_images/10_Complex_rotation_2.svg"><img alt="../_images/10_Complex_rotation_2.svg" src="../_images/10_Complex_rotation_2.svg" style="width: 300px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 108 </span><span class="caption-text">The complex number <span class="math notranslate nohighlight">\(z\)</span> is the real number 1 rotated <span class="math notranslate nohighlight">\(\theta\)</span> anti-clockwise in the complex plane.</span><a class="headerlink" href="#complex-rotation-2-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Recall that <span class="math notranslate nohighlight">\(\cos(\theta) = \dfrac{adjacent}{hypotenuse}\)</span> and <span class="math notranslate nohighlight">\(\sin(\theta) = \dfrac{opposite}{hypotenuse}\)</span> and since the hypotenuse is 1 then</p>
<div class="math notranslate nohighlight">
\[ z = \cos(\theta) + \sin(\theta)i.\]</div>
<p>This means we can rotate by an arbitrary angle <span class="math notranslate nohighlight">\(\theta\)</span> in the complex plane by multiplying by <span class="math notranslate nohighlight">\(z\)</span>.</p>
</section>
</section>
<hr class="docutils" />
<section id="quaternions">
<h2>Quaternions<a class="headerlink" href="#quaternions" title="Link to this heading">#</a></h2>
<p>A <strong>quaternion</strong> is an extension of a complex number where we add two additional imaginary numbers. The general form of a quaternion is</p>
<div class="math notranslate nohighlight">
\[ q = w + xi + yj + zk, \]</div>
<p>where <span class="math notranslate nohighlight">\(w\)</span>, <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(z\)</span> are real numbers and <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(j\)</span> and <span class="math notranslate nohighlight">\(k\)</span> are imaginary numbers which are related to <span class="math notranslate nohighlight">\(-1\)</span> and each other by</p>
<div class="math notranslate nohighlight">
\[i^2 = j^2 = k^2 = ijk = -1. \]</div>
<p>Quaternions are more commonly represented in scalar-vector form where we use a 3-element vector for the imaginary coefficients</p>
<div class="math notranslate nohighlight">
\[q = [w, (x, y, z)],\]</div>
<p>where <span class="math notranslate nohighlight">\(w\)</span> is known as the <strong>scalar</strong> part of a quaternion and <span class="math notranslate nohighlight">\((x, y, z)\)</span> is the <strong>vector</strong> part. We are going to create a Quaternion class so that we can work with quaternions.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following class definition to the *<strong>maths.js</strong> file</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span><span class="w"> </span><span class="nx">Quaternion</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">w</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">3</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">3</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">3</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">3</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="sb">`[ </span><span class="si">${</span><span class="nx">w</span><span class="si">}</span><span class="sb">, ( </span><span class="si">${</span><span class="nx">x</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">y</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">z</span><span class="si">}</span><span class="sb"> ) ]`</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And add the following code to the <em><strong>quaternion_calculations.js</strong></em> file</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;q = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">q</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Here we have defined a Quaternion class that contains a constructor to initialize the quaternion using input parameters for <span class="math notranslate nohighlight">\(w\)</span>, <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(z\)</span> components and a method to output a string for printing. We have also created a new quaternion object for the quaternion <span class="math notranslate nohighlight">\([1, (2, 3, 4)]\)</span>. Refresh your browser, and you should see the following added to the webpage</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>q = [ 1.000, ( 2.000, 3.000, 4.000 ) ]
</pre></div>
</div>
<section id="quaternion-magnitude">
<h3>Quaternion magnitude<a class="headerlink" href="#quaternion-magnitude" title="Link to this heading">#</a></h3>
<p>The <strong>magnitude</strong>, or length, of a quaternion <span class="math notranslate nohighlight">\(q\)</span> is denoted by <span class="math notranslate nohighlight">\(| q |\)</span> and calculated in a similar way to how we calculate <a class="reference internal" href="04_Vectors_and_matrices.html#vector-magnitude-section"><span class="std std-ref">vector magnitude</span></a></p>
<div class="math notranslate nohighlight">
\[ |q| = \sqrt{w^2 + x^2 + y^2 + z^2}. \]</div>
<p>For example, given the quaternion <span class="math notranslate nohighlight">\(q = [1, (2, 3, 4)]\)</span> then</p>
<div class="math notranslate nohighlight">
\[ |q| = \sqrt{1^2 + 2^2 + 3^2 + 4^2} = \sqrt{1 + 4 + 9 + 16} = \sqrt{30} = 5.477. \]</div>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following method to the Quaternion class</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">length</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">z</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And add the following code to the <em><strong>quaternion_calculations.js</strong></em> file</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;length(q) = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="p">());</span>
</pre></div>
</div>
</div>
<p>Here we have added the method <code class="docutils literal notranslate"><span class="pre">length()</span></code> that computes the magnitude of the quaternion object and used it to calculate the magnitude of the quaternion <span class="math notranslate nohighlight">\([1, (2, 3, 4)]\)</span>. Refresh your browser, and you should see the following added to the webpage</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>length(q) = 5.477225575051661
</pre></div>
</div>
</section>
<section id="unit-quaternion">
<h3>Unit quaternion<a class="headerlink" href="#unit-quaternion" title="Link to this heading">#</a></h3>
<p>A <strong>unit quaternion</strong> is a quaternion denoted by <span class="math notranslate nohighlight">\(\hat{q}\)</span> that has a magnitude of 1. We can <strong>normalize</strong> a quaternion in a similar way we did for vectors to convert to a unit quaternion.</p>
<div class="math notranslate nohighlight">
\[ \begin{align*}
  \hat{q} &amp;= \frac{q}{| q |}.
\end{align*} \]</div>
<p>For example, given the quaternion <span class="math notranslate nohighlight">\(q = [1, (2, 3, 4)]\)</span> then normalizing this gives</p>
<div class="math notranslate nohighlight">
\[ \begin{align*}
  \hat{q} &amp;= \frac{[1, (2, 3, 4)]}{5.477} = [0.183, (0.365, 0.548, 0.730)].
\end{align*} \]</div>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following method to the Quaternion class</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">normalize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">len</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">inv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="nx">inv</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="nx">inv</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="nx">inv</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="nx">inv</span><span class="p">;</span>
<span class="w">  </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And add the following code to the <em><strong>quaternion_calculations.js</strong></em> file</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">qHat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">).</span><span class="nx">normalize</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\nqHat = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">qHat</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;length(qHat) = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">qHat</span><span class="p">.</span><span class="nx">length</span><span class="p">());</span>
</pre></div>
</div>
</div>
<p>Here we have added the method <code class="docutils literal notranslate"><span class="pre">normalize()</span></code> to the Quaternion class that normalizes the quaternion object. Refresh your browser, and you should see the following added to the webpage</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>qHat = [ 0.183, ( 0.365, 0.548, 0.730 ) ]
length(qHat) = 0.9999999999999999
</pre></div>
</div>
</section>
<section id="multiplying-quaternions">
<h3>Multiplying quaternions<a class="headerlink" href="#multiplying-quaternions" title="Link to this heading">#</a></h3>
<p>The multiplication of two quaternions <span class="math notranslate nohighlight">\(q_1 = [w_1, (x_1, y_1, z_1)]\)</span> and <span class="math notranslate nohighlight">\(q_2 = [w_2, (x_2, y_2, z_2)]\)</span> results in the quaternion <span class="math notranslate nohighlight">\(q_1 \, q_2 = [w, (x, y, z)]\)</span> where</p>
<div class="math notranslate nohighlight" id="equation-quaternion-product-equation-1">
<span class="eqno">(27)<a class="headerlink" href="#equation-quaternion-product-equation-1" title="Link to this equation">#</a></span>\[\begin{split} \begin{align*}
  w &amp;= w_1w_2 - x_1x_2 - y_1y_2 - z_1z_2, \\
  x &amp;= w_1x_2 + x_1w_2 + y_1z_2 - z_1y_2, \\
  y &amp;= w_1y_2 - x_1z_2 + y_1w_2 + z_1x_2, \\
  z &amp;= w_1z_2 + x_1y_2 - y_1x_2 + z_1w_2.
\end{align*}\end{split}\]</div>
<p>If <span class="math notranslate nohighlight">\(q_1 = [w_1, \vec{a}]\)</span> and <span class="math notranslate nohighlight">\(q_2 = [w_2, \vec{b}]\)</span> then we can write quaternion multiplication as</p>
<div class="math notranslate nohighlight" id="equation-quaternion-product-equation-2">
<span class="eqno">(28)<a class="headerlink" href="#equation-quaternion-product-equation-2" title="Link to this equation">#</a></span>\[ \begin{align*}
  q_1 \, q_2 = [w_1w_2 - \vec{a} \cdot \vec{b}, w_1 \vec{a} + w_2 \vec{b} + \vec{a} \times \vec{b}].
\end{align*} \]</div>
<p>You don’t need to know where equations <a class="reference internal" href="#equation-quaternion-product-equation-1">(27)</a> and <a class="reference internal" href="#equation-quaternion-product-equation-2">(28)</a> come from but if you are curious, click on the dropdown below.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Derivation of quaternion multiplication equation</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Let <span class="math notranslate nohighlight">\(q_1 = x_1i + y_1j + z_1k + w_1\)</span> and <span class="math notranslate nohighlight">\(q_2 = x_2i + y_2j + z_2k + w_2\)</span> be two quaternions then multiplying them gives</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    q_1 \, q_2 &amp;= (w_1 + x_1i + y_1j + z_1k)(w_2 + x_2i + y_2j + z_2k) \\
    &amp;= w_1w_2 + w_1x_2i + w_1y_2j + w_1z_2k \\
    &amp; \quad + x_1w_2i + x_1x_2i^2 + x_1y_2ij + x_1z_2ik \\
    &amp; \quad + y_1w_2j + y_1x_2ji + y_1y_2j^2 + y_1z_2jk \\
    &amp; \quad + z_1w_2k + z_1x_2ki + z_1y_2kj + z_1z_2k^2.
\end{align*} \end{split}\]</div>
<p class="sd-card-text">Since <span class="math notranslate nohighlight">\(i^2 = j^2 = k^2 = -1\)</span>, <span class="math notranslate nohighlight">\(ij = k\)</span>, <span class="math notranslate nohighlight">\(ik = -j\)</span>, <span class="math notranslate nohighlight">\(ji = -k\)</span>, <span class="math notranslate nohighlight">\(jk = i\)</span>, <span class="math notranslate nohighlight">\(ki = j\)</span>, <span class="math notranslate nohighlight">\(kj = -i\)</span> then</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
  q_1 \, q_2 &amp;= w_1w_2 + w_1x_2i + w_1y_2j + w_1z_2k \\
  &amp; \quad + x_1w_2i - x_1x_2 + x_1y_2k - x_1z_2j \\
  &amp; \quad + y_1w_2j - y_1x_2k - y_1y_2 + y_1z_2i \\
  &amp; \quad + z_1w_2k + z_1x_2j - z_1y_2i - z_1z_2.
\end{align*} \end{split}\]</div>
<p class="sd-card-text">Factorising the real and imaginary parts</p>
<div class="math notranslate nohighlight" id="equation-quaternion-multiplication-equation-3">
<span class="eqno">(29)<a class="headerlink" href="#equation-quaternion-multiplication-equation-3" title="Link to this equation">#</a></span>\[\begin{split} \begin{align*}
  q_1 \, q_2 &amp;= w_1w_2 - x_1x_2 - y_1y_2 - z_1z_2 \\
  &amp; \quad + (w_1x_2 + x_1w_2 + y_1z_2 - z_1y_2)i \\
  &amp; \quad + (w_1y_2 - x_1z_2 + y_1w_2 + z_1x_2)j \\
  &amp; \quad + (w_1z_2 + x_1y_2 - y_1x_2 + z_1w_2)k.
\end{align*} \end{split}\]</div>
<p class="sd-card-text">We can write this in scalar-vector form <span class="math notranslate nohighlight">\(q_1 \, q_2 = [w, (x, y, z)]\)</span> where</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
  w &amp;= w_1w_2 - x_1x_2 - y_1y_2 - z_1z_2, \\
  x &amp;= w_1x_2 + x_1w_2 + y_1z_2 - z_1y_2, \\
  y &amp;= w_1y_2 - x_1z_2 + y_1w_2 + z_1x_2, \\
  z &amp;= w_1z_2 + x_1y_2 - y_1x_2 + z_1w_2.
\end{align*}\end{split}\]</div>
<p class="sd-card-text">We can write equation <a class="reference internal" href="#equation-quaternion-multiplication-equation-3">(29)</a> by multiplying by the quaternions <span class="math notranslate nohighlight">\([1, (0, 0, 0)]\)</span> for the scalar part and <span class="math notranslate nohighlight">\(i = [0, (1, 0, 0)]\)</span>, <span class="math notranslate nohighlight">\(j = [0, (0, 1, 0)]\)</span> and <span class="math notranslate nohighlight">\(k = [0, (0, 0, 1)]\)</span> for the imaginary parts</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    q_1 \, q_2 &amp;= (w_1w_2 - x_1x_2 - y_1y_2 - z_1z_2)[1, (0, 0, 0)] \\
    &amp; \quad + (w_1x_2 + x_1w_2 + y_1z_2 - z_1y_2)[0, (1, 0, 0)] \\
    &amp; \quad + (w_1y_2 - x_1z_2 + y_1w_2 + z_1x_2)[0, (0, 1, 0)] \\
    &amp; \quad + (w_1z_2 + x_1y_2 - y_1x_2 + z_1w_2)[0, (0, 0, 1)] \\
    &amp;= [w_1w_2 - x_1x_2 - y_1y_2 - z_1z_2, \\
    &amp; \quad w_1(x_2, y_2, z_2) + w_2(x_1, y_1, z_2)\\
    &amp; \quad + (y_1z_2 - z_1y_2, z_1x_2 - x_1z_2, x_1y_2 - y_1x_2)]
\end{align*} \end{split}\]</div>
<p class="sd-card-text">Since</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    (x_1, y_1, z_1) \cdot (x_2, y_2, z_2) &amp;= x_1x_2 + y_1y_2 + z_1z_2, \\
    (x_1, y_1, z_1) \times (x_2, y_2, z_2) &amp;= (y_1z_2 - z_1y_2, z_1x_2 - x_1z_2, x_1y_2 - y_1x_2)
\end{align*} \end{split}\]</div>
<p class="sd-card-text">then</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    q_1 \, q_2 &amp;= [w_1w_2 - (x_1, y_1, z_1) \cdot (x_2, y_2, z_2), \\
    &amp; \qquad w_1(x_2, y_2, z_2) + w_2(x_1, y_1, z_2) + (x_1, y_1, z_1) \times (x_2, y_2, z_2)]
\end{align*} \end{split}\]</div>
<p class="sd-card-text">Let <span class="math notranslate nohighlight">\(\vec{a} = (x_1, y_1, z_1)\)</span> and <span class="math notranslate nohighlight">\(\vec{b} = (x_2, y_2, z_2)\)</span> such that <span class="math notranslate nohighlight">\(q_1 = [w_1, \vec{a}]\)</span> and <span class="math notranslate nohighlight">\(q_2 = [w_2, \vec{b}]\)</span> then</p>
<div class="math notranslate nohighlight">
\[ q_1 \, q_2 = [w_1w_2 - \vec{a} \cdot \vec{b}, w_1 \vec{b} + w_2 \vec{a} + \vec{a} \times \vec{b}].\]</div>
</div>
</details><p>For example, given the quaternions <span class="math notranslate nohighlight">\(q_1 = [1, (2, 3, 4)]\)</span> and <span class="math notranslate nohighlight">\(q_2 = [5, (6, 7, 8)]\)</span> then</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
  w &amp;= 1 \times 5 - 2 \times 6 - 3 \times 7 - 4 \times 8 = -60, \\
  x &amp;= 1 \times 6 + 2 \times 5 + 3 \times 8 - 4 \times 7 = 12, \\
  y &amp;= 1 \times 7 - 2 \times 8 + 3 \times 5 + 4 \times 6 = 30, \\
  z &amp;= 1 \times 8 + 2 \times 7 - 3 \times 6 + 4 \times 5 = 24,
\end{align*} \end{split}\]</div>
<p>so <span class="math notranslate nohighlight">\(q_1 \, q_2 = [-60, (12, 30, 24)]\)</span>.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following method to the Quaternion class</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">multiply</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>

<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And add the following code to the <em><strong>quaternion_calculations.js</strong></em> file</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="mf">6</span><span class="p">,</span><span class="w"> </span><span class="mf">7</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\nq1 = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">q1</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;q2 = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">q2</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;q1 x q2 = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">q1</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">q2</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>Here we have added the method <code class="docutils literal notranslate"><span class="pre">multiply()</span></code> to the Quaternion class that multiplies the current quaternion object by another quaternion and used it to calculate <span class="math notranslate nohighlight">\([1, (2, 3, 4)][5, (6, 7, 8)]\)</span>. Refresh your browser, and you should see the following added to the webpage</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>q1 = [ 1.000, ( 2.000, 3.000, 4.000 ) ]
q2 = [ 5.000, ( 6.000, 7.000, 8.000 ) ]
q1 x q2 = [ -60.000, ( 12.000, 30.000, 24.000 ) ]
</pre></div>
</div>
</section>
<section id="quaternion-inverse">
<h3>Quaternion inverse<a class="headerlink" href="#quaternion-inverse" title="Link to this heading">#</a></h3>
<p>The <strong>inverse</strong> of a quaternion <span class="math notranslate nohighlight">\(q\)</span> is denoted by <span class="math notranslate nohighlight">\(q^{-1}\)</span> and is defined by</p>
<div class="math notranslate nohighlight" id="equation-quaternion-inverse-definition">
<span class="eqno">(30)<a class="headerlink" href="#equation-quaternion-inverse-definition" title="Link to this equation">#</a></span>\[ q  q^{-1} = q^{-1} \, q = 1. \]</div>
<p>To calculate the inverse or the quaternion <span class="math notranslate nohighlight">\(q = [w, (x, y, z)]\)</span>, we need to consider its <strong>conjugate</strong> of which is denoted by <span class="math notranslate nohighlight">\(q^*\)</span> and is defined by</p>
<div class="math notranslate nohighlight">
\[ \begin{align*}
    q^* = [w, (-x, -y, -z)],
\end{align*} \]</div>
<p>i.e., the sign of the vector part is negated. Note that multiplying <span class="math notranslate nohighlight">\(q\)</span> by its conjugate results in <span class="math notranslate nohighlight">\(q q^*=q^* \, q = |q|^2\)</span> so multiplying both sides of equation <a class="reference internal" href="#equation-quaternion-inverse-definition">(30)</a> by <span class="math notranslate nohighlight">\(q^*\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
  q^* \, q q^{-1} &amp;= q^* \\
  |q|^2 q^{-1} &amp;= q^* \\
  q^{-1} &amp;= \frac{q^*}{|q|^2}.
\end{align*} \end{split}\]</div>
<p>If <span class="math notranslate nohighlight">\(q\)</span> is a unit quaternion then <span class="math notranslate nohighlight">\(|q|=1\)</span> and <span class="math notranslate nohighlight">\(q^{-1} = q^*\)</span>. For example, given the quaternion <span class="math notranslate nohighlight">\(q = [1, (2, 3, 4)]\)</span>, then since <span class="math notranslate nohighlight">\(|q| = \sqrt{30}\)</span> then</p>
<div class="math notranslate nohighlight">
\[ \begin{align*}
  q^{-1} &amp;= \frac{[1, (-2, -3, -4)]}{30} = [0.033, (-0.067, -0.1, -0.133)].
\end{align*} \]</div>
<p>Checking that this is the inverse of <span class="math notranslate nohighlight">\(q\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
  q q^{-1} &amp;= [1, (-2, -3, -4)][0.183, (-0.365, -0.548, -0.730)] \\
  &amp;= [1, (0, 0, 0)].
\end{align*} \end{split}\]</div>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following method to the Quaternion class</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">inverse</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">len2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">len2</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Cannot invert a zero quaternion&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">(</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">len2</span><span class="p">,</span>
<span class="w">        </span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">len2</span><span class="p">,</span>
<span class="w">        </span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">len2</span><span class="p">,</span>
<span class="w">        </span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">len2</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And add the following code to the <em><strong>quaternion_calculations.js</strong></em> file</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Quaternion inverse</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">qInv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">inverse</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\nqInv = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">qInv</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;qInv x q = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">qInv</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">q</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Here we have defined the Quaternion class method <code class="docutils literal notranslate"><span class="pre">inverse()</span></code> which calculates the inverse of the current quaternion, and we have used it to calculate the inverse of the quaternion <span class="math notranslate nohighlight">\([1, (2, 3, 4)]\)</span>. Refresh your browser, and you should see the following added to the webpage</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>qInv = [ 0.033, ( -0.067, -0.100, -0.133 ) ]
qInv x q = [ 1.000, ( 0.000, 0.000, 0.000 ) ]
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="rotations-using-quaternions">
<h2>Rotations using quaternions<a class="headerlink" href="#rotations-using-quaternions" title="Link to this heading">#</a></h2>
<p>We saw above that we can rotate a number in the complex plane by multiplying by the complex number</p>
<div class="math notranslate nohighlight">
\[ z = \cos(\theta) + i\sin(\theta). \]</div>
<p>To rotate a quaternion <span class="math notranslate nohighlight">\(p\)</span> we simply multiply it by another quaternion <span class="math notranslate nohighlight">\(q\)</span> that represents the rotation we wish to apply</p>
<div class="math notranslate nohighlight">
\[ p' = q p, \]</div>
<p>where <span class="math notranslate nohighlight">\(q\)</span> is defined by</p>
<div class="math notranslate nohighlight" id="equation-rotation-quaternion-equation">
<span class="eqno">(31)<a class="headerlink" href="#equation-rotation-quaternion-equation" title="Link to this equation">#</a></span>\[ q = [\cos(\tfrac{1}{2}\theta), \sin(\tfrac{1}{2}\theta) \hat{\vec{v}} ]. \]</div>
<p>To apply the rotation quaternion to rotate the vector <span class="math notranslate nohighlight">\(\vec{p}\)</span> we need to define the quaternion <span class="math notranslate nohighlight">\(p = [0, \vec{p}]\)</span> and then calculate</p>
<div class="math notranslate nohighlight" id="equation-quaternion-rotation-multiplication-equation">
<span class="eqno">(32)<a class="headerlink" href="#equation-quaternion-rotation-multiplication-equation" title="Link to this equation">#</a></span>\[p' = q p q^{-1},\]</div>
<p>which returns a quaternion of the form <span class="math notranslate nohighlight">\(p' = [0, \vec{p}']\)</span> where <span class="math notranslate nohighlight">\(\vec{p}'\)</span> is the rotated vector. You don’t need to know why we need to use 2 multiplications in equation <a class="reference internal" href="#equation-quaternion-rotation-multiplication-equation">(32)</a> but if you are curious, click on the dropdown below.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Derivation of the equation for rotating a vector using quaternions</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Consider the rotation of the vector <span class="math notranslate nohighlight">\(\vec{p} = (2, 0, 0)\)</span> by 45<span class="math notranslate nohighlight">\(^\circ\)</span> about the vector <span class="math notranslate nohighlight">\(\hat{\vec{v}} = (0, 0, 1)\)</span> the points along the <span class="math notranslate nohighlight">\(z\)</span>-axis. The rotation quaternion for this is</p>
<div class="math notranslate nohighlight">
\[ q = [\cos(45^\circ), \sin(45^\circ)(0, 0, 1)] =  [0.707, (0, 0, 0.707)]. \]</div>
<p class="sd-card-text">Expressing <span class="math notranslate nohighlight">\(\vec{p}\)</span> as a quaternion we have <span class="math notranslate nohighlight">\(p = [0, (2, 0, 0)]\)</span> and rotating this using <span class="math notranslate nohighlight">\(q\)</span> we have</p>
<div class="math notranslate nohighlight">
\[ \begin{align*}
    p' = q p &amp;= [0.707, (0, 0, 0.707)] [0, (2, 0, 0)] = [0, (1.414, 1.414, 0)]
\end{align*} \]</div>
<p class="sd-card-text">The scalar part of <span class="math notranslate nohighlight">\(p'\)</span> is zero so we can extract the rotated vector which is <span class="math notranslate nohighlight">\(\vec{p}' = (1.414, 1.414, 0)\)</span>. This rotation is shown below.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/10_quaternion_rotation_1.svg"><img alt="../_images/10_quaternion_rotation_1.svg" src="../_images/10_quaternion_rotation_1.svg" style="width: 450px;" />
</a>
</figure>
<p class="sd-card-text">This example rotated about a vector that points along one of the axes, what happens when we rotate by a vector that doesn’t? Consider the rotation of the same vector <span class="math notranslate nohighlight">\(\vec{p} = (2, 0, 0)\)</span> by angle <span class="math notranslate nohighlight">\(45^\circ\)</span> about the unit vector <span class="math notranslate nohighlight">\(\hat{\vec{v}} =  (0.707, 0, 0.707)\)</span>, the rotation quaternion is</p>
<div class="math notranslate nohighlight">
\[ \begin{align*}
    q = [\cos(45^\circ), \sin(45^\circ)(0.707, 0, 0.707)] = [0.707,(0.5, 0, 0.5)]
\end{align*} \]</div>
<p class="sd-card-text">Calculating <span class="math notranslate nohighlight">\(q \, p\)</span></p>
<div class="math notranslate nohighlight">
\[ \begin{align*}
    p' = q p &amp;= [0.707,(0.5, 0, 0.5)] [0, (2, 0, 0)] = [-1, (1.414, 1, 0)].
\end{align*} \]</div>
<p class="sd-card-text">Now the real part is non-zero, so we can’t extract the rotated vector. However, if we multiply <span class="math notranslate nohighlight">\(q p\)</span> by the inverse of the rotation quaternion <span class="math notranslate nohighlight">\(q^{-1}\)</span> on the right we have</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    p' = q p q^{-1} &amp;= [0.707,(0.5, 0, 0.5)] [0, (2, 0, 0)] [0.707, (-0.5, 0, -0.5)] \\
    &amp;= [0, (1, 1.414, 1)]
\end{align*} \end{split}\]</div>
<p class="sd-card-text">The real part of <span class="math notranslate nohighlight">\(p'\)</span> is zero, so we can extract the rotated vector which is <span class="math notranslate nohighlight">\(\vec{p}' = (1, 1.414, 1)\)</span>.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/10_quaternion_rotation_2.svg"><img alt="../_images/10_quaternion_rotation_2.svg" src="../_images/10_quaternion_rotation_2.svg" style="width: 450px;" />
</a>
</figure>
<p class="sd-card-text">The plot of this rotation above shows that we have rotated by <span class="math notranslate nohighlight">\(90^\circ\)</span> instead of the desired <span class="math notranslate nohighlight">\(45^\circ\)</span>. This is because we have applied two rotations of <span class="math notranslate nohighlight">\(45^\circ\)</span>, so we need to halve the angle in the rotation quaternion is</p>
<div class="math notranslate nohighlight">
\[ q = [\cos(\tfrac{1}{2}\theta), \sin(\tfrac{1}{2}\theta) \hat{\vec{v}}].\]</div>
<p class="sd-card-text">So our rotation quaternion is</p>
<div class="math notranslate nohighlight">
\[q = [\cos(\tfrac{45^\circ}{2}), \sin(\tfrac{45^\circ}{2})(0.707, 0, 0.707)] = [0.924, (0.271, 0, 0.271)]. \]</div>
<p class="sd-card-text">Now calculating the rotation we have</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    p' = q p q^{-1} &amp;= [0.924, (0.271, 0, 0.271)] [0,(2,0,0)] [0.924, (-0.271, 0, -0.271)] \\
    &amp;= [0, (1.707, 1, 0.293)].
\end{align*}\end{split}\]</div>
<p class="sd-card-text">The plot of this rotation below shows that this is the correct rotation.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/10_quaternion_rotation_3.svg"><img alt="../_images/10_quaternion_rotation_3.svg" src="../_images/10_quaternion_rotation_3.svg" style="width: 450px;" />
</a>
</figure>
</div>
</details><p>For example, consider the rotation of the vector <span class="math notranslate nohighlight">\(\vec{p} = (1, 0, 0)\)</span> that points along the <span class="math notranslate nohighlight">\(x\)</span>-axis by <span class="math notranslate nohighlight">\(90^\circ\)</span> about the vector <span class="math notranslate nohighlight">\(\vec{v} = (0, 1, 0)\)</span> which points along the <span class="math notranslate nohighlight">\(y\)</span>-axis. The resulting vector should be <span class="math notranslate nohighlight">\(\vec{v}' = (0, 0, -1)\)</span>, i.e., a vector pointing down the <span class="math notranslate nohighlight">\(z\)</span>-axis. Here <span class="math notranslate nohighlight">\(p = [0, (1, 0, 0)]\)</span> and the rotation quaternion and its inverse is</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    q &amp;= [\cos(45^\circ), \sin(45^\circ) (0, 1, 0)] = [0.707, (0, 0.707, 0)], \\
    q^{-1} &amp;= [0.707, (0, -0.707, 0)]
\end{align*} \end{split}\]</div>
<p>Computing <span class="math notranslate nohighlight">\(q p q^{-1}\)</span> gives</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
  q p q^{-1} &amp;= [0.707, (0, 0.707, 0)][0, (1, 0, 0)][0.707, (0, -0.707, 0)] \\
  &amp;= [0, (0.707, 0, -0.707)][0.707, (0, -0.707, 0)] \\
  &amp;= [0, (0, 0, -1)]
\end{align*} \end{split}\]</div>
<p>So <span class="math notranslate nohighlight">\(\vec{p}' = (0, 0, -1)\)</span> as expected.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following method to the Quaternion class</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="nx">fromAxisAngle</span><span class="p">(</span><span class="nx">axis</span><span class="p">,</span><span class="w"> </span><span class="nx">angle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalize</span><span class="p">(</span><span class="nx">axis</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">halfAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">angle</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">halfAngle</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">(</span>
<span class="w">        </span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">halfAngle</span><span class="p">),</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">axis</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">axis</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span>
<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">axis</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">rotateVector</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">v</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">v</span><span class="p">[</span><span class="mf">2</span><span class="p">]);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">qInv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">inverse</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">p</span><span class="p">).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">qInv</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">result</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">z</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And add the following code to the <em><strong>quaternion_calculations.js</strong></em> file</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Quaternion rotation</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">];</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">axis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">];</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">90</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">180</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">qRot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">.</span><span class="nx">fromAxisAngle</span><span class="p">(</span><span class="nx">axis</span><span class="p">,</span><span class="w"> </span><span class="nx">angle</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\nQuaternion rotation\n-------------------&quot;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;p = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">printVector</span><span class="p">(</span><span class="nx">p</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;qRot = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">qRot</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;pRotated = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">printVector</span><span class="p">(</span><span class="nx">qRot</span><span class="p">.</span><span class="nx">rotateVector</span><span class="p">(</span><span class="nx">p</span><span class="p">)));</span>
</pre></div>
</div>
</div>
<p>Here we have defined two Quaternion class methods <code class="docutils literal notranslate"><span class="pre">fromAxisAngle()</span></code> using equation <a class="reference internal" href="#equation-rotation-quaternion-equation">(31)</a> and <code class="docutils literal notranslate"><span class="pre">rotateVector()</span></code> which calculates the rotation quaternion and rotates a vector using the current quaternion object. We have then used these to rotate the vector <span class="math notranslate nohighlight">\((1, 0, 0)\)</span> about the the vector <span class="math notranslate nohighlight">\((0, 1, 0)\)</span> by <span class="math notranslate nohighlight">\(90^\circ\)</span>. Refresh your browser, and you should see the following added to the webpage</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Quaternion rotation
-------------------
p = [ 1.00, 0.00, 0.00 ]
qRot = [ 0.707, ( 0.000, 0.707, 0.000 ) ]
pRotated = [ 0.00, 0.00, -1.00 ]
</pre></div>
</div>
<section id="matrix-representation-of-a-quaternion">
<h3>Matrix representation of a quaternion<a class="headerlink" href="#matrix-representation-of-a-quaternion" title="Link to this heading">#</a></h3>
<p>We have been using <span class="math notranslate nohighlight">\(4 \times 4\)</span> matrices to compute the transformations to convert between model, view and screen spaces, so in order to use quaternions for rotations we need to calculate a <span class="math notranslate nohighlight">\(4 \times 4\)</span> rotation matrix that is equivalent to <span class="math notranslate nohighlight">\(q p q^{-1}\)</span>. If the rotation quaternion is <span class="math notranslate nohighlight">\(q = [w, (x, y, z)]\)</span>, and <span class="math notranslate nohighlight">\(q\)</span> is a unit quaternion, then the corresponding rotation matrix is</p>
<div class="math notranslate nohighlight" id="equation-quaternion-rotation-matrix-equation">
<span class="eqno">(33)<a class="headerlink" href="#equation-quaternion-rotation-matrix-equation" title="Link to this equation">#</a></span>\[\begin{split} \begin{align*}
    Rotate &amp;=
    \begin{pmatrix}
        1 - 2(y^2 + z^2) &amp; 2(xy + wz) &amp; 2(xz - wy) &amp; 0 \\
        2(xy - wz) &amp; 1 - 2(x^2 + z^2) &amp; 2(yz + wx) &amp; 0 \\
        2(xz + wy) &amp; 2(yz - wx) &amp; 1 - 2(x^2 + y^2) &amp; 0 \\
        0 &amp; 0 &amp; 0 &amp; 1
    \end{pmatrix}
\end{align*} \end{split}\]</div>
<p>You don’t need to know the derivation of the quaternion rotation matrix but if you are curious, click on the dropdown below.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Derivation of quaternion rotation matrix</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">To derive a <span class="math notranslate nohighlight">\(4 \times 4\)</span> transformation matrix that achieves quaternion rotation, consider the multiplication of the quaternion <span class="math notranslate nohighlight">\(p = [p_w, (p_x, p_y, p_z)]\)</span> on the left by the rotation quaternion <span class="math notranslate nohighlight">\(q = [w, (x, y, z)]\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    q p &amp;= [w, (x, y, z)] [p_w, (p_x, p_y, p_z)] \\
    &amp;= [wp_w - (x, y, z) \cdot (p_x, p_y, p_z), w(p_x, p_y, p_z) + p_w(x, y, z) + (x, y, z) \times (p_x, p_y, p_z)] \\
    &amp;= [wp_w - xp_x - yp_y - zp_z, \\
    &amp;\qquad (wp_x - zp_y - yp_z + xp_w, zp_x + wp_y - xp_z + yp_w, -yp_x + xp_y + wp_z + zp_w)].
\end{align*} \end{split}\]</div>
<p class="sd-card-text">If we write the quaternion <span class="math notranslate nohighlight">\(p\)</span> as a 4-element vector of the form <span class="math notranslate nohighlight">\(\vec{p} = (p_x, p_y, p_z, p_w)^\mathsf{T}\)</span> (note that <span class="math notranslate nohighlight">\(p_w\)</span>, is now at the end of the vector which is synonymous with <a class="reference internal" href="05_Transformations.html#homogeneous-coordinates-section"><span class="std std-ref">homogeneous co-ordinates</span></a>) then we have</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    q p &amp;=
    \begin{pmatrix}
         wp_x - zp_y + yp_z + xp_w \\
         zp_x + wp_y - xp_z + yp_w \\
        -yp_x + xp_y + wp_z + zp_w \\
        -xp_x - yp_y - zp_z + wp_w
    \end{pmatrix},
\end{align*} \end{split}\]</div>
<p class="sd-card-text">and we can express the rotation <span class="math notranslate nohighlight">\(q p\)</span> as the matrix equation</p>
<div class="math notranslate nohighlight" id="equation-quaternion-rotation-q-equation">
<span class="eqno">(34)<a class="headerlink" href="#equation-quaternion-rotation-q-equation" title="Link to this equation">#</a></span>\[\begin{split} q p = \begin{align*}
    \begin{pmatrix}
         w &amp; -z &amp;  y &amp; x \\
         z &amp;  w &amp; -x &amp; y \\
        -y &amp;  x &amp;  w &amp; z \\
        -x &amp; -y &amp; -z &amp; w
    \end{pmatrix}
    \begin{pmatrix} p_x \\ p_y \\ p_z \\ p_w \end{pmatrix}
\end{align*} \end{split}\]</div>
<p class="sd-card-text">Doing similar for multiplying <span class="math notranslate nohighlight">\(p\)</span> on the right by the inverse rotation quaternion <span class="math notranslate nohighlight">\(q^{-1} = [w, (-x, -y, -z)]\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    p q^{-1} &amp;= [p_w, (p_x, p_y, p_z)][w, (-x, -y, -z)] \\
    &amp;= [wp_w - (p_x, p_y, p_z) \cdot ( -x, -y, -z), \\
    &amp; \qquad p_w(-x, -y, -z) + w(p_x, p_y, p_z) + (p_x, p_y, p_z) \times (-x, -y, -z)] \\
    &amp;= [xp_x + yp_y + zp_z + wp_w, \\
    &amp; \qquad (wp_x - zp_y + yp_z - xp_w, zp_x + wp_y - xp_z - yp_w, -yp_x + xp_y + wp_z - zp_w)].
\end{align*} \end{split}\]</div>
<p class="sd-card-text">Writing <span class="math notranslate nohighlight">\(p\)</span> the form <span class="math notranslate nohighlight">\(\vec{p} = (p_x, p_y, p_z, p_w)\)</span> as before gives</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    p q^{-1} =
    \begin{pmatrix}
        wp_x - zp_y + yp_z - xp_w \\
        zp_x + wp_y - xp_z - yp_w \\
        -yp_x + xp_y + wp_z - zp_w \\
        xp_x + yp_y + zp_z + wp_w
    \end{pmatrix}
\end{align*} \end{split}\]</div>
<p class="sd-card-text">which can be expressed by the matrix equation</p>
<div class="math notranslate nohighlight" id="equation-quaternion-rotation-q2-equation">
<span class="eqno">(35)<a class="headerlink" href="#equation-quaternion-rotation-q2-equation" title="Link to this equation">#</a></span>\[\begin{split} \begin{align*}
    p q^{-1} &amp;=
    \begin{pmatrix}
        w &amp; -z &amp; y &amp; -x \\
        z &amp; w &amp; -x &amp; -y \\
        -y &amp; x &amp; w &amp; -z \\
        x &amp; y &amp; z &amp; w
    \end{pmatrix}
    \begin{pmatrix} p_x \\ p_y \\ p_z \\ p_w \end{pmatrix}
\end{align*} \end{split}\]</div>
<p class="sd-card-text">The two matrices for <span class="math notranslate nohighlight">\(q p\)</span> and <span class="math notranslate nohighlight">\(p q^{-1}\)</span> from equations <a class="reference internal" href="#equation-quaternion-rotation-q-equation">(34)</a> and <a class="reference internal" href="#equation-quaternion-rotation-q2-equation">(35)</a> can be combined to give a single matrix <span class="math notranslate nohighlight">\(R\)</span> that performs the quaternion rotation <span class="math notranslate nohighlight">\(q p q^{-1}\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    R &amp;= (q p) \cdot (p q^{-1})
    =
    \begin{pmatrix}
        w &amp; -z &amp; y &amp; -x \\
        z &amp; w &amp; -x &amp; -y \\
        -y &amp; x &amp; w &amp; -z \\
        x &amp; y &amp; z &amp; w
    \end{pmatrix}
    \begin{pmatrix}
        w &amp; -z &amp; y &amp; x \\
        z &amp; w &amp; -x &amp; y \\
        -y &amp; x &amp; w &amp; z \\
        -x &amp; -y &amp; -z &amp; w
    \end{pmatrix} \\
    &amp;=
    \begin{pmatrix}
        x^2 - y^2 - z^2 + w^2 &amp; 2(xy - wz) &amp; 2(xz + wy) &amp; 0 \\
        2(xy + wz) &amp; -x^2 + y^2 - z^2 + w^2 &amp; 2(yz - wx) &amp; 0 \\
        2(xz - wy) &amp; 2(wx + yz) &amp; -x^2 - y^2 + z^2 + w^2 &amp; 0 \\
        0 &amp; 0 &amp; 0 &amp; x^2 + y^2 + z^2 + w^2
    \end{pmatrix}.
\end{align*} \end{split}\]</div>
<p class="sd-card-text">Recall that <span class="math notranslate nohighlight">\(q\)</span> is a unit quaternion so <span class="math notranslate nohighlight">\(x^2 + y^2 + z^2 + w^2 = 1\)</span>. We can use this to simplify the main diagonal elements of <span class="math notranslate nohighlight">\(R\)</span>, for example, consider the element in row 1 column 1 of <span class="math notranslate nohighlight">\(R\)</span></p>
<div class="math notranslate nohighlight">
\[ \begin{align*}
    x^2 - y^2 - z^2 + w^2 = 1 - 2(y^2 + z^2).
\end{align*} \]</div>
<p class="sd-card-text">Doing this for the other main diagonal elements <span class="math notranslate nohighlight">\(R\)</span> simplifies to</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    R &amp;=
    \begin{pmatrix}
        1 - 2(y^2 + z^2) &amp; 2(xy - wz) &amp; 2(xz + wy) &amp; 0 \\
        2(xy + wz) &amp; 1 - 2(x^2 + z^2) &amp; 2(yz - wx) &amp; 0 \\
        2(xz - wy) &amp; 2(wx + yz) &amp; 1 - 2(x^2 + y^2) &amp; 0 \\
        0 &amp; 0 &amp; 0 &amp; 1
    \end{pmatrix}.
\end{align*} \end{split}\]</div>
<p class="sd-card-text">Transposing <span class="math notranslate nohighlight">\(R\)</span> for use with column-major ordering gives</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    R &amp;=
    \begin{pmatrix}
        1 - 2(y^2 + z^2) &amp; 2(xy + wz) &amp; 2(xz - wy) &amp; 0 \\
        2(xy - wz) &amp; 1 - 2(x^2 + z^2) &amp; 2(yz + wx) &amp; 0 \\
        2(xz + wy) &amp; 2(yz - wx) &amp; 1 - 2(x^2 + y^2) &amp; 0 \\
        0 &amp; 0 &amp; 0 &amp; 1
    \end{pmatrix}.
\end{align*} \end{split}\]</div>
</div>
</details><div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following method to the Quaternion class</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">matrix</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">z</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">xx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">yy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">zz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">z</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">wx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">wy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">wz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">z</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">xy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span><span class="w"> </span><span class="nx">xz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">z</span><span class="p">,</span><span class="w"> </span><span class="nx">yz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">z</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Mat4</span><span class="p">().</span><span class="nx">set</span><span class="p">([</span>
<span class="w">        </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">yy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">zz</span><span class="p">),</span><span class="w">  </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">xy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">wz</span><span class="p">),</span><span class="w">      </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">xz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">wy</span><span class="p">),</span><span class="w">      </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">xy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">wz</span><span class="p">),</span><span class="w">      </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">xx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">zz</span><span class="p">),</span><span class="w">  </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">yz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">wx</span><span class="p">),</span><span class="w">      </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">xz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">wy</span><span class="p">),</span><span class="w">      </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">yz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">wx</span><span class="p">),</span><span class="w">      </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">xx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">yy</span><span class="p">),</span><span class="w">  </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">0</span><span class="p">,</span><span class="w">                  </span><span class="mf">0</span><span class="p">,</span><span class="w">                  </span><span class="mf">0</span><span class="p">,</span><span class="w">                  </span><span class="mf">1</span>
<span class="w">    </span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And add the following code to the <em><strong>quaternion_calculations.js</strong></em> file</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">quaternionRotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rotationQuaternion</span><span class="p">.</span><span class="nx">matrix</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\nquaternion rotation matrix =\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">quaternionRotation</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">rotationMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Mat4</span><span class="p">().</span><span class="nx">rotate</span><span class="p">(</span><span class="nx">axis</span><span class="p">,</span><span class="w"> </span><span class="nx">angle</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\nrotation matrix =\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">rotationMatrix</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Here we have defined the Quaternion class method <code class="docutils literal notranslate"><span class="pre">matrix()</span></code> that returns the <span class="math notranslate nohighlight">\(4 \times 4\)</span> quaternion rotation matrix for a rotation quaternion. We then print this, as well as the standard axis-angle rotation matrix from equation <a class="reference internal" href="05_Transformations.html#equation-eq-axis-angle-rotation-matrix">(14)</a> that we derived in <a class="reference internal" href="05_Transformations.html#axis-angle-rotation-section"><span class="std std-ref">Lab 5: Transformations</span></a>. Refresh your browser, and you should see the following added to the webpage</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>quaternion rotation matrix =
  [    0.00     0.00    -1.00     0.00 ]
  [    0.00     1.00     0.00     0.00 ]
  [    1.00     0.00     0.00     0.00 ]
  [    0.00     0.00     0.00     1.00 ]

rotation matrix =
  [    0.00     0.00    -1.00     0.00 ]
  [    0.00     1.00     0.00     0.00 ]
  [    1.00     0.00     0.00     0.00 ]
  [    0.00     0.00     0.00     1.00 ]
</pre></div>
</div>
<p>Note that both matrices are equivalent (you can change the axis and angles to confirm this works for other quaternions), so why are we bothering with quaternion rotation? Comparing the code for the <code class="docutils literal notranslate"><span class="pre">matrix()</span></code> Quaternion class method with the <code class="docutils literal notranslate"><span class="pre">rotate()</span></code> method from the Mat4 class we can see the quaternion rotation matrix requires 16 multiplications compared to 24 multiplications to calculate the rotation matrix. Efficiency is always a bonus, but the main advantage is the quaternion rotation matrix does not suffer from gimbal lock so it will work for any configuration.</p>
<p>So it makes sense to use the quaternion rotation matrix for our axis-angle rotations.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Edit the <code class="docutils literal notranslate"><span class="pre">rotate()</span></code> Mat4 class method, so that is looks like the following</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">rotate</span><span class="p">(</span><span class="nx">axis</span><span class="p">,</span><span class="w"> </span><span class="nx">angle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rotationQuaternion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">.</span><span class="nx">fromAxisAngle</span><span class="p">(</span><span class="nx">axis</span><span class="p">,</span><span class="w"> </span><span class="nx">angle</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">rotationQuaternion</span><span class="p">.</span><span class="nx">matrix</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<!-- ### Calculating a quaternion from Euler angles

Quaternions can be thought of as an orientation in 3D space. Imagine a camera in the world space that is pointing in a particular direction. The direction in which the camera is pointing can be described with reference to the $x$, $y$ and $z$ axes in terms of the $pitch$, $yaw$ and $roll$ Euler angles. Since multiplying rotation quaternions achieves rotation, then if $q_y$, $q_p$ and $q_r$ are rotation quaternions for rotating about the $yaw$, $pitch$ and $roll$ then the quaternion that gives the camera orientation is calculated using $q_y q_p q_r$ where

$$ \begin{align*}
  q_y &= [c_y, (s_y, 0, 0)], \\
  q_p &= [c_p, (0, s_p, 0)], \\
  q_r &= [c_r, (0, 0, s_r)].
\end{align*} $$

and

$$ \begin{align*}
    c_x &= \cos(\tfrac{pitch}{2}), &
    c_y &= \cos(\tfrac{yaw}{2}), &
    c_z &= \cos(\tfrac{roll}{2}) \\
    s_x &= \sin(\tfrac{pitch}{2}), &
    s_y &= \sin(\tfrac{yaw}{2}), &
    s_z &= \sin(\tfrac{roll}{2}).
\end{align*} $$

Therefore,

$$ \begin{align*}
  q_yq_pq_r &= [c_y, (0, s_y, 0)] \, [c_p, (s_p, 0, 0)] \, [c_r, (0, 0, s_r)] \\
  &= [c_yc_pc_r + s_ys_ps_r, (c_ys_pc_r + s_yc_ps_r, s_yc_pc_r - c_ys_ps_r, c_yc_ps_r - s_ys_pc_r)]
\end{align*} $$(euler-to-quaternion-equation)

:::{admonition} Task
:class: tip

Add the following method to the Quaternion class

```javascript
fromEuler(yaw, pitch, roll) {
    const cy = Math.cos(0.5 * yaw);
    const sy = Math.sin(0.5 * yaw);
    const cp = Math.cos(0.5 * pitch);
    const sp = Math.sin(0.5 * pitch);
    const cr = Math.cos(0.5 * roll);
    const sr = Math.sin(0.5 * roll);

    return new Quaternion(
        cy * cp * cr + sy * sp * sr,
        cy * sp * cr + sy * cp * sr,
        sy * cp * cr - cy * sp * sr,
        cy * cp * sr - sy * sp * cr
    );
}
```

And add the following code to the ***quaternion_calculations.js*** file

```javascript
const yaw = 45 * Math.PI / 180;
const pitch = 45 * Math.PI / 180;
const q3 = new Quaternion.fromEuler(yaw, pitch, 0.0);
console.log("\nq3 = " + q3);
```

:::

Refresh your browser, and you should see the following added to the webpage

```text
q3 = [ 0.854, ( 0.354, 0.354, -0.146 ) ]
```

--- -->
</section>
</section>
<hr class="docutils" />
<section id="a-quaternion-camera">
<h2>A Quaternion camera<a class="headerlink" href="#a-quaternion-camera" title="Link to this heading">#</a></h2>
<p>Now that we have built a Quaternion class we can now use quaternions to perform calculations in the Camera class to implement a quaternion camera. We are currently using Euler angles rotation to calculate the camera vectors in the <code class="docutils literal notranslate"><span class="pre">update()</span></code> method and our camera may suffer from gimbal lock. It also does not allow us to move the camera through <span class="math notranslate nohighlight">\(\pm 90^\circ\)</span> to look straight up or down (recall that we needed to limit the <span class="math notranslate nohighlight">\(pitch\)</span> angle between <span class="math notranslate nohighlight">\(\pm 89^\circ\)</span>).</p>
<p>To implement a quaternion camera we create a quaternion that describes the rotation of the camera in the world space. We rotate the camera quaternion using two rotation quaternions based on changes to the <span class="math notranslate nohighlight">\(yaw\)</span> and <span class="math notranslate nohighlight">\(pitch\)</span> angles from the mouse input. Once we have the rotated camera quaternion we can use it to rotate vectors pointing along the <span class="math notranslate nohighlight">\(x\)</span> and negative <span class="math notranslate nohighlight">\(z\)</span> axes to give the <span class="math notranslate nohighlight">\(\vec{right}\)</span> and <span class="math notranslate nohighlight">\(\vec{front}\)</span> vectors for moving the camera. We can also use the matrix form of the camera quaternion to calculate the view matrix.</p>
<p>For example, consider the camera quaternion <span class="math notranslate nohighlight">\(q_{camera} = [1, (0, 0, 0)]\)</span> which represents a camera pointing down the <span class="math notranslate nohighlight">\(z\)</span>-axis. Let’s say the user moves the mouse to the upwards resulting in a <span class="math notranslate nohighlight">\(pitch\)</span> angle of <span class="math notranslate nohighlight">\(45^\circ\)</span> (which is <span class="math notranslate nohighlight">\(\frac{\pi}{4}\)</span> in radians) then we need to rotate <span class="math notranslate nohighlight">\(q_{camera}\)</span> about the <span class="math notranslate nohighlight">\(x\)</span>-axis by multiplying by</p>
<div class="math notranslate nohighlight">
\[ q_{pitch} = [\cos(\tfrac{\pi}{8}), \sin(\tfrac{\pi}{8})(1, 0, 0)] = [0.924, (0.383, 0, 0)].\]</div>
<p>Performing the quaternion multiplication we have</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    q_{pitch} \, q_{camera} &amp;= [0.924, (0.383, 0, 0)] \, [1, (0, 0, 0)] \\
    &amp;= [0.924, (0.383, 0, 0)].
\end{align*} \end{split}\]</div>
<figure class="align-default" id="id1">
<a class="reference internal image-reference" href="../_images/10_quaternion_camera_1.svg"><img alt="../_images/10_quaternion_camera_1.svg" src="../_images/10_quaternion_camera_1.svg" style="width: 350px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 109 </span><span class="caption-text">Rotation of the camera quaternion <span class="math notranslate nohighlight">\(q_{camera}\)</span> around the <span class="math notranslate nohighlight">\(x\)</span>-axis by the angle <span class="math notranslate nohighlight">\(pitch\)</span>.</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Let’s say the user also moves the mouse to the left resulting in a <span class="math notranslate nohighlight">\(yaw\)</span> angle of <span class="math notranslate nohighlight">\(30^\circ\)</span> (which is <span class="math notranslate nohighlight">\(\frac{\pi}{6}\)</span> in radians) then we need to rotate about the <span class="math notranslate nohighlight">\(y\)</span>-axis by multiplying <span class="math notranslate nohighlight">\(q_{pitch} \, q_{camera}\)</span> by</p>
<div class="math notranslate nohighlight">
\[ q_{yaw} = [\cos(\tfrac{\pi}{12}), \sin(\tfrac{\pi}{12})(0, 1, 0)] = [0.966, (0, 0.259, 0)]. \]</div>
<p>Performing the quaternion multiplication we have</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    q_{yaw} \, q_{pitch} \, q_{camera} &amp;= [0.966, (0, 0.259, 0)] \, [0.924, (0.383, 0, 0)] \\
    &amp;= [0.892, (0.370, 0.239, -0.099)].
\end{align*} \end{split}\]</div>
<p>Note that quaternion multiplication is applied right-to-left so <span class="math notranslate nohighlight">\(q_{yaw} \, q_{pitch} \, q_{camera}\)</span> means that the <span class="math notranslate nohighlight">\(q_{camera}\)</span> is multiplied by <span class="math notranslate nohighlight">\(q_{pitch}\)</span> first and then multiplied by <span class="math notranslate nohighlight">\(q_{yaw}\)</span>.</p>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="../_images/10_quaternion_camera_2.svg"><img alt="../_images/10_quaternion_camera_2.svg" src="../_images/10_quaternion_camera_2.svg" style="width: 300px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 110 </span><span class="caption-text">Rotation of the camera quaternion <span class="math notranslate nohighlight">\(q_{camera}'\)</span> around the <span class="math notranslate nohighlight">\(x\)</span>-axis by the angle <span class="math notranslate nohighlight">\(pitch\)</span>.</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Once the camera quaternion has been rotated using the <span class="math notranslate nohighlight">\(pitch\)</span> and <span class="math notranslate nohighlight">\(yaw\)</span> angles, we can use equation <a class="reference internal" href="#equation-quaternion-rotation-multiplication-equation">(32)</a> to rotate the vectors <span class="math notranslate nohighlight">\((0, 0, -1)\)</span>, <span class="math notranslate nohighlight">\((1, 0, 0)\)</span> and <span class="math notranslate nohighlight">\((0, 1, 0)\)</span> to determine the local camera vectors <span class="math notranslate nohighlight">\(\vec{front}\)</span>, <span class="math notranslate nohighlight">\(\vec{right}\)</span> and <span class="math notranslate nohighlight">\(\vec{up}\)</span>. In addition, we can use the inverse of the quaternion matrix form of the camera quaternion to calculate the view matrix using</p>
<div class="math notranslate nohighlight">
\[ View = q_{camera}^{-1} \cdot Translate(-\vec{eye}). \]</div>
<p>The reason we use the inverse camera quaternion is that we want to rotate the world space in the opposite direction to the camera rotation, i.e., the world space rotates around the camera so when we move the mouse to the right, the world space rotates to the left.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>In the <em><strong>camera.js</strong></em> file delete the camera vectors <span class="math notranslate nohighlight">\(\vec{worldUp}\)</span>, <span class="math notranslate nohighlight">\(\vec{front}\)</span>, <span class="math notranslate nohighlight">\(\vec{right}\)</span> and <span class="math notranslate nohighlight">\(\vec{up}\)</span> (but keep the <span class="math notranslate nohighlight">\(\vec{eye}\)</span> vector) as well as the <span class="math notranslate nohighlight">\(yaw\)</span> and <span class="math notranslate nohighlight">\(pitch\)</span> properties from the Camera class constructor (we will no longer need these since the camera vectors are calculated using a quaternion) and add the following quaternion to the constructor</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Rotation quaternion</span>
<span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">();</span>
</pre></div>
</div>
<p>Change the <code class="docutils literal notranslate"><span class="pre">update()</span></code> method so that is looks like the following</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">update</span><span class="p">(</span><span class="nx">dt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// Pitch rotation (rotate around local right vector)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">localRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">rotateVector</span><span class="p">([</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">]);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pitchQuat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">.</span><span class="nx">fromAxisAngle</span><span class="p">(</span><span class="nx">localRight</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pitch</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Yaw rotation (rotate around y-axis)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">yawQuat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Quaternion</span><span class="p">.</span><span class="nx">fromAxisAngle</span><span class="p">([</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">yaw</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Zero yaw and pitch angles</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Rotate camera quaternion</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">yawQuat</span>
<span class="w">        </span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">pitchQuat</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">normalize</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Calculate front and right camera vectors</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">front</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">rotateVector</span><span class="p">([</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">]);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">rotateVector</span><span class="p">([</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">]);</span>

<span class="w">    </span><span class="c1">// Camera movement</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">];</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">])</span><span class="w"> </span><span class="nx">vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">addVector</span><span class="p">(</span><span class="nx">vel</span><span class="p">,</span><span class="w"> </span><span class="nx">front</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">])</span><span class="w"> </span><span class="nx">vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">subtractVector</span><span class="p">(</span><span class="nx">vel</span><span class="p">,</span><span class="w"> </span><span class="nx">front</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">])</span><span class="w"> </span><span class="nx">vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">subtractVector</span><span class="p">(</span><span class="nx">vel</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">])</span><span class="w"> </span><span class="nx">vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">addVector</span><span class="p">(</span><span class="nx">vel</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">length</span><span class="p">(</span><span class="nx">vel</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">vel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalize</span><span class="p">(</span><span class="nx">vel</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">eye</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">addVector</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">eye</span><span class="p">,</span><span class="w"> </span><span class="nx">scaleVector</span><span class="p">(</span><span class="nx">vel</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">dt</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">mouseMove()</span></code> function change the <code class="docutils literal notranslate"><span class="pre">+=</span></code> to <code class="docutils literal notranslate"><span class="pre">-=</span></code> in the command to update the <span class="math notranslate nohighlight">\(yaw\)</span> angle and delete the commands that limit the <span class="math notranslate nohighlight">\(pitch\)</span> angle.</p>
<p>Then replace the <code class="docutils literal notranslate"><span class="pre">getViewMatrix()</span></code> function with the following</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">getViewMatrix</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rotate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">inverse</span><span class="p">().</span><span class="nx">matrix</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">translate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Mat4</span><span class="p">().</span><span class="nx">translate</span><span class="p">([</span>
<span class="w">        </span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">eye</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
<span class="w">        </span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">eye</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span>
<span class="w">        </span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">eye</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
<span class="w">    </span><span class="p">]);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">rotate</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">translate</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Here we have made the changes to implement a quaternion camera. In <code class="docutils literal notranslate"><span class="pre">update()</span></code> we use quaternions to rotate the camera quaternion based on the <span class="math notranslate nohighlight">\(yaw\)</span> and <span class="math notranslate nohighlight">\(pitch\)</span> angles from the mouse input. We then use the new camera quaternion to rotate the vectors <span class="math notranslate nohighlight">\((0, 0, -1)\)</span> and <span class="math notranslate nohighlight">\((1, 0, 0)\)</span> to give the <span class="math notranslate nohighlight">\(\vec{front}\)</span> and <span class="math notranslate nohighlight">\(\vec{right}\)</span> camera vectors. We have also changed the <code class="docutils literal notranslate"><span class="pre">getViewMatrix()</span></code> function so that it uses the camera quaternion to compute the view matrix.</p>
<p>Load <em><strong>index.html</strong></em> in a live server and you should see that nothing much has changed, you can still move the camera around using the keyboard and mouse. However, now we have a quaternion camera which does not suffer from gimbal lock and we can also move the camera through <span class="math notranslate nohighlight">\(\pm 90^\circ\)</span>.</p>
<center>
<video autoplay controls muted="true" loop="true" width="500">
    <source src="../_static/videos/10_quaternion_camera.mp4" type="video/mp4">
</video>
</center>
</section>
<hr class="docutils" />
<section id="slerp">
<h2>SLERP<a class="headerlink" href="#slerp" title="Link to this heading">#</a></h2>
<p>Another advantage that quaternions have over Euler angles is that we can easily interpolate between two quaternions smoothly and without encountering the problem of gimble lock. Standard Linear intERPolation (LERP) is used to calculate an intermediate position on the straight line between two points.</p>
<figure class="align-default" id="id3">
<a class="reference internal image-reference" href="../_images/10_LERP.svg"><img alt="../_images/10_LERP.svg" src="../_images/10_LERP.svg" style="width: 300px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 111 </span><span class="caption-text">Linear interpolation between two points.</span><a class="headerlink" href="#id3" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>If <span class="math notranslate nohighlight">\(\vec{v}_1\)</span> and <span class="math notranslate nohighlight">\(\vec{v}_2\)</span> are two points then another point, <span class="math notranslate nohighlight">\(\vec{v}_t\)</span>, that lies on the line between <span class="math notranslate nohighlight">\(\vec{v}_1\)</span> and <span class="math notranslate nohighlight">\(\vec{v}_2\)</span> is calculated using</p>
<div class="math notranslate nohighlight">
\[ \operatorname{LERP}(\vec{v}_1, \vec{v}_2, t) = \vec{v}_1 + t(\vec{v}_2 - \vec{v}_1), \]</div>
<p>where <span class="math notranslate nohighlight">\(t\)</span> is a value between 0 and 1.</p>
<p><strong>SLERP</strong> stands for Spherical Linear intERPolation and is a method used to interpolate between two quaternions across a surface of a sphere.</p>
<figure class="align-default" id="a-slerp-figure">
<a class="reference internal image-reference" href="../_images/10_SLERP.svg"><img alt="../_images/10_SLERP.svg" src="../_images/10_SLERP.svg" style="width: 400px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 112 </span><span class="caption-text">SLERP interpolation between two points on a sphere.</span><a class="headerlink" href="#a-slerp-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Consider <a class="reference internal" href="#a-slerp-figure"><span class="std std-numref">Fig. 112</span></a> where <span class="math notranslate nohighlight">\(q_1\)</span> and <span class="math notranslate nohighlight">\(q_2\)</span> are two quaternions emanating from the centre of a sphere (note that this diagram is a bit misleading as quaternions exist in 4 dimensions but since it’s very difficult to visualize 4D on a 2D screen this will have to do). The interpolated quaternion <span class="math notranslate nohighlight">\(q_t\)</span> represents another quaternion that is partway between <span class="math notranslate nohighlight">\(q_1\)</span> and <span class="math notranslate nohighlight">\(q_2\)</span> calculated using</p>
<div class="math notranslate nohighlight" id="equation-slerp-equation">
<span class="eqno">(36)<a class="headerlink" href="#equation-slerp-equation" title="Link to this equation">#</a></span>\[ \begin{align*}
    \operatorname{SLERP}(q_1, q_2, t) = \frac{\sin((1-t) \theta)}{\sin(\theta)} \, q_1 + \frac{\sin(t\theta)}{\sin(\theta)} \, q_2
\end{align*}, \]</div>
<p>where <span class="math notranslate nohighlight">\(t\)</span> is a value between 0 and 1 and <span class="math notranslate nohighlight">\(\theta\)</span> is the angle between the two quaternions and is calculated using</p>
<div class="math notranslate nohighlight">
\[ \theta = \cos^{-1} \left( \frac{q_1 \cdot q_2}{|q_1||q_2|} \right),\]</div>
<p>where <span class="math notranslate nohighlight">\(q_1 \cdot q_2\)</span> is the dot product between the two quaternions and calculated in the same way as the <a class="reference internal" href="04_Vectors_and_matrices.html#dot-product-section"><span class="std std-ref">dot product between two 4-element vectors</span></a>. Sometimes <span class="math notranslate nohighlight">\(q_1 \cdot q_2\)</span> returns a negative result meaning that <span class="math notranslate nohighlight">\(\theta\)</span> we will be interpolating the long way round the sphere. To overcome this we negate the values of one of the quaternions, this is fine since the quaternion <span class="math notranslate nohighlight">\(-q\)</span> is the same orientation as <span class="math notranslate nohighlight">\(q\)</span>. Another consideration is when <span class="math notranslate nohighlight">\(\theta\)</span> is very small then <span class="math notranslate nohighlight">\(\sin(\theta)\)</span> in equation <a class="reference internal" href="#equation-slerp-equation">(36)</a> can be rounded to zero causing a divide by zero error. To get around this we can use LERP between <span class="math notranslate nohighlight">\(q_1\)</span> and <span class="math notranslate nohighlight">\(q_2\)</span>.</p>
<p>To calculate SLERP between two quaternions <span class="math notranslate nohighlight">\(q_1 = [w_1, (x_1, y_1, z_1)]\)</span> and <span class="math notranslate nohighlight">\(q_2 = [w_2, (x_2, y_2, z_2)]\)</span> we do the following:</p>
<ul class="simple">
<li><p>Calculate <span class="math notranslate nohighlight">\(\cos(\theta) = w_1w_2 + x_1x_2 + y_1y_2 + z_1z_2\)</span></p></li>
<li><p>If <span class="math notranslate nohighlight">\(\cos(\theta) &lt; 0\)</span> then <span class="math notranslate nohighlight">\(q_2 = -q_2\)</span> and <span class="math notranslate nohighlight">\(\cos(\theta) = -\cos(\theta)\)</span></p></li>
<li><p>If <span class="math notranslate nohighlight">\(\cos(\theta) &gt; 0.9995\)</span> (i.e., <span class="math notranslate nohighlight">\(q_1\)</span> and <span class="math notranslate nohighlight">\(q_2\)</span> are very close) use LERP</p></li>
</ul>
<div class="math notranslate nohighlight">
\[q_t = q_1 + t  (q_2 - q_1).\]</div>
<ul class="simple">
<li><p>Else use SLERP</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ q_t = \frac{\sin((1 - t) \theta)}{\sin(\theta)} \, q_1 + \frac{\sin(t\theta)}{\sin(\theta)} \, q_2, \]</div>
<p>where <span class="math notranslate nohighlight">\(t =  1 - \exp(-rotation \, speed \times \Delta t)\)</span> for exponential damping.</p>
<p>To implement smoothing in a first-person camera we calculate a target quaternion using the mouse input and then use SLERP to calculate the interpolated quaternion between the current camera quaternion and the target quaternion (<a class="reference internal" href="#slerped-camera-figure"><span class="std std-numref">Fig. 113</span></a>). This interpolated quaternion becomes the camera quaternion and is used to perform the rotations on the camera vectors.</p>
<figure class="align-default" id="slerped-camera-figure">
<a class="reference internal image-reference" href="../_images/10_slerped_camera.svg"><img alt="../_images/10_slerped_camera.svg" src="../_images/10_slerped_camera.svg" style="width: 350px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 113 </span><span class="caption-text">Camera smoothing using SLERP.</span><a class="headerlink" href="#slerped-camera-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The effects of applying SLERP to smooth the camera rotation can be seen in the video below (the effects are best experienced by moving the camera yourself).</p>
<center>
<video autoplay controls muted="true" loop="true" width="60%">
    <source src="../_static/videos/10_slerped_camera.mp4" type="video/mp4">
</video>
</center>
</section>
<hr class="docutils" />
<section id="third-person-camera">
<h2>Third person camera<a class="headerlink" href="#third-person-camera" title="Link to this heading">#</a></h2>
<p>The use of quaternions allows game developers to implement third person camera view in 3D games where the camera follows the character that the player is controlling. This was first done for the Playstation game <em>Tomb Raider</em> released by Core Design in 1996 and has become popular with game developers with game franchises such as <em>God of War</em>, <em>Horizon Zero Dawn</em>, <em>Assassins Creed</em> and <em>Red Dead Redemption</em> to name a few all using third person camera view.</p>
<figure class="align-default" id="third-person-camera-figure">
<a class="reference internal image-reference" href="../_images/10_Third_person_camera.svg"><img alt="../_images/10_Third_person_camera.svg" src="../_images/10_Third_person_camera.svg" style="width: 400px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 114 </span><span class="caption-text">A third person camera that follows a character.</span><a class="headerlink" href="#third-person-camera-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>To implement a simple third person camera, we calculate the view matrix as usual and then move the camera back by translating by an <span class="math notranslate nohighlight">\(\vec{offset}\)</span> vector <a class="reference internal" href="#third-person-camera-figure"><span class="std std-numref">Fig. 114</span></a>.</p>
<div class="math notranslate nohighlight">
\[ View = Translate(\vec{offset}) \cdot View \]</div>
<p>The result of a third-person camera view can be seen below. Here we are using <a href="https://en.wikipedia.org/wiki/Blender_(software)#Suzanne" target="_blank">Suzanne the Blender mascot</a> to act as our character model, and we can switch from first-person to third-person view using keyboard input.</p>
<center>
<video autoplay controls muted="true" loop="true" width="500">
    <source src="../_static/10_Third_person_camera_1.mp4" type="video/mp4">
</video>
</center>
<p>Moving the camera around we see that our character model is always facing in the same direction. To make it face in the same direction as the camera we combine pitch and yaw rotations, and use them in the model matrix calculation for the character model.</p>
<div class="math notranslate nohighlight">
\[ Rotate = R_y(yaw) \cdot R_x(pitch).\]</div>
<center>
<video autoplay controls muted="true" loop="true" width="500">
    <source src="../_static/10_Third_person_camera_2.mp4" type="video/mp4">
</video>
</center>
<p>Implementations of a third-person camera can vary. For example, you may want the character movement to be independent of the camera movement so that the camera is not always behind the character. To do this we would calculate the view matrix for a third-person camera as seen above, but calculate a different orientation for the character based on a different <span class="math notranslate nohighlight">\(yaw\)</span> angle that can be altered using keyboard inputs (<a class="reference internal" href="#third-person-camera-figure-2"><span class="std std-numref">Fig. 115</span></a>).</p>
<figure class="align-default" id="third-person-camera-figure-2">
<a class="reference internal image-reference" href="../_images/10_Third_person_camera_2.svg"><img alt="../_images/10_Third_person_camera_2.svg" src="../_images/10_Third_person_camera_2.svg" style="width: 450px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 115 </span><span class="caption-text">A third person camera that is independent of the character orientation.</span><a class="headerlink" href="#third-person-camera-figure-2" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<hr class="docutils" />
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Add the ability for the user to switch between view modes where pressing the 1 key selects first-person camera and pressing the 2 key selects a third person camera. In third-person camera mode the camera should follow the character and point in the same direction as the character is facing.</p></li>
</ol>
<p>The Suzanne model and textures can be downloaded from the <a href="https://github.com/jonshiach/Computer-Graphics-Labs/tree/main/assets" target="_blank">GitHub repository</a> (this was only added recently so you might not have it).</p>
<ol class="arabic simple" start="2">
<li><p>Add the ability for the user to select a different third-person camera mode by pressing the 3 key. In this mode, the camera should be independent of the character movement where it can rotate around the character based on the camera <span class="math notranslate nohighlight">\(yaw\)</span> and <span class="math notranslate nohighlight">\(pitch\)</span> angles. The character movement direction should be governed by a character <span class="math notranslate nohighlight">\(yaw\)</span> angle that can be altered by the A and D keys.</p></li>
</ol>
<center>
<video autoplay controls muted="true" loop="true" width="500">
    <source src="../_static/10_Third_person_camera_3.mp4" type="video/mp4">
</video>
</center>
</section>
<hr class="docutils" />
<section id="video-walkthrough">
<h2>Video walkthrough<a class="headerlink" href="#video-walkthrough" title="Link to this heading">#</a></h2>
<p>The video below walks you through these lab materials.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-hodWDPpV9w?si=SouaIdCqYoy6wEmb" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./_pages"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="09_Normal_mapping.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lab 9: Normal Mapping</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#complex-numbers">Complex Numbers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rotation-using-complex-numbers">Rotation using complex numbers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quaternions">Quaternions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quaternion-magnitude">Quaternion magnitude</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unit-quaternion">Unit quaternion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiplying-quaternions">Multiplying quaternions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quaternion-inverse">Quaternion inverse</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rotations-using-quaternions">Rotations using quaternions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#matrix-representation-of-a-quaternion">Matrix representation of a quaternion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-quaternion-camera">A Quaternion camera</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slerp">SLERP</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#third-person-camera">Third person camera</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#video-walkthrough">Video walkthrough</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dr Jon Shiach
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>