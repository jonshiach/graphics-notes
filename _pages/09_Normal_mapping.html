
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lab 9: Normal Mapping &#8212; Computer Graphics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex": {"macros": {"vec": ["\\mathbf{#1}", 1]}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_pages/09_Normal_mapping';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lab 10: Quaternions" href="10_Quaternions.html" />
    <link rel="prev" title="Lab 8: Lighting" href="08_Lighting.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Computer Graphics - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Computer Graphics - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Contents
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preliminaries</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="P_Core_concepts.html">Core Computer Graphics Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="P_Software.html">Visual Studio Code</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Labs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_intro_to_javascript.html">Lab 1: Introduction to JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Basic_shapes.html">Lab 2: Drawing Basic Shapes in WebGL</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Textures.html">Lab 3: Textures</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_Vectors_and_matrices.html">Lab 4: Vectors and Matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_Transformations.html">Lab 5: Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_3D_worlds.html">Lab 6: 3D Worlds</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_Moving_the_camera.html">Lab 7: Moving the Camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_Lighting.html">Lab 8: Lighting</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lab 9: Normal Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_Quaternions.html">Lab 10: Quaternions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="A1_Complex_numbers_and_quaternions.html">Appendix A: Complex Numbers and Quaternions</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/jonshiach/graphics-notes" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jonshiach/graphics-notes/issues/new?title=Issue%20on%20page%20%2F_pages/09_Normal_mapping.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/_pages/09_Normal_mapping.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lab 9: Normal Mapping</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tangent-space">Tangent space</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-the-tangent-vectors">Calculating the tangent vectors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#shaders">Shaders</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#specular-maps">Specular maps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#video-walkthrough">Video walkthrough</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lab-9-normal-mapping">
<span id="normal-mapping-section"></span><h1>Lab 9: Normal Mapping<a class="headerlink" href="#lab-9-normal-mapping" title="Link to this heading">#</a></h1>
<p>In <a class="reference internal" href="08_Lighting.html#lighting-section"><span class="std std-ref">Lab 8: Lighting</span></a> we saw that the diffuse and specular reflection models used the light source position and surface normal vector to determine the colour of a fragment. The vertex shader was used to interpolate the normal vectors for each fragment based on the normal vectors at the vertices of a triangle. This works well for smooth objects, but for objects with a rough or patterned surface we don’t get the benefits of highlights and shadow. <strong>Normal mapping</strong> is technique that uses a <a class="reference internal" href="03_Textures.html#textures-section"><span class="std std-ref">texture map</span></a> to define the normal vectors for each fragment so that when a lighting model is applied it gives the appearance of a non-flat surface.</p>
<figure class="align-default" id="id1">
<a class="reference internal image-reference" href="../_images/09_normal_mapping.svg"><img alt="../_images/09_normal_mapping.svg" src="../_images/09_normal_mapping.svg" style="width: 600px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 94 </span><span class="caption-text">Normal mapping applies a texture of normals for each fragment giving the appearance of a non-flat surface.</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>A <strong>normal map</strong> is a texture where the RGB colour values of each textel is used for the normal vector <span class="math notranslate nohighlight">\(\vec{n} = (n_x, n_y, n_z)\)</span> where <span class="math notranslate nohighlight">\(n_x\)</span>, <span class="math notranslate nohighlight">\(n_y\)</span> and <span class="math notranslate nohighlight">\(n_z\)</span> values are determined by the red, green and blue colours values respectively. A normal map for the crate texture is shown in <a class="reference internal" href="#crate-normal-map-figure"><span class="std std-numref">Fig. 95</span></a>.</p>
<figure class="align-default" id="crate-normal-map-figure">
<a class="reference internal image-reference" href="../_images/09_crate_normal.png"><img alt="../_images/09_crate_normal.png" src="../_images/09_crate_normal.png" style="width: 400px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 95 </span><span class="caption-text">A normal map for the crate texture.</span><a class="headerlink" href="#crate-normal-map-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Normal maps tend to have a blue tinge to them because the normal vectors are pointing away from the surface so the <span class="math notranslate nohighlight">\(z\)</span> component dominates. Any red on a normal map suggests that the normal is pointing to the right and green suggests the normal is pointing upwards.</p>
<figure class="align-default" id="normal-map-figure">
<a class="reference internal image-reference" href="../_images/09_normal_map.svg"><img alt="../_images/09_normal_map.svg" src="../_images/09_normal_map.svg" style="width: 350px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 96 </span><span class="caption-text">The RBG values of a normal map give the values of the normal vectors.</span><a class="headerlink" href="#normal-map-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Create a copy of your <em><strong>Lab 8 Lighting</strong></em> folder, rename it <em><strong>Lab 9 Normal Mapping</strong></em>, rename the file <em><strong>lighting.js</strong></em> to <em><strong>normal_mapping.js</strong></em> and change <em><strong>index.html</strong></em> so that the page title is “Lab 9 - Normal Maps” it uses <em><strong>normal_mapping.js</strong></em>.</p>
</div>
<p>Load <em><strong>index.html</strong></em> in a live server, and you should see the cubes from <a class="reference internal" href="08_Lighting.html#lighting-section"><span class="std std-ref">Lab 8: Lighting</span></a> lit using a point light, a spotlight and a directional light source.</p>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="../_images/09_cubes.png"><img alt="../_images/09_cubes.png" src="../_images/09_cubes.png" style="width: 80%;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 97 </span><span class="caption-text">The cubes lit using three light sources from <a class="reference internal" href="08_Lighting.html#lighting-section"><span class="std std-ref">Lab 8: Lighting</span></a>.</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Download the file <a class="reference download internal" download="" href="../_downloads/9f5dc76b0f274192cd4ada632c6cf33d/crate_normal.png"><span class="xref download myst">crate_normal.png</span></a> and save it to the <em><strong>Lab 9 - Normal Mapping/assets/</strong></em> folder.</p>
<p>Add the following just after we have loaded the crate texture.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">normalMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">loadTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;assets/crate_normal.png&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>And add the following asfter we bind the crate texture in the <code class="docutils literal notranslate"><span class="pre">render()</span></code> function.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Bind normal map</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE1</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span><span class="w"> </span><span class="nx">normalMap</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uNormalMap&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Here we have loaded the normal map for the crate texture and bind it to the sampler <code class="docutils literal notranslate"><span class="pre">uNormalMap</span></code>. Note that here we used the texture unit <code class="docutils literal notranslate"><span class="pre">gl.TEXTURE1</span></code> which tells WebGL this is the second texture we are sending to the shaders (see <a class="reference internal" href="03_Textures.html#multiple-textures-section"><span class="std std-ref">Multiple textures</span></a>).</p>
<hr class="docutils" />
<section id="tangent-space">
<h2>Tangent space<a class="headerlink" href="#tangent-space" title="Link to this heading">#</a></h2>
<p>We have already seen in <a class="reference internal" href="06_3D_worlds.html#d-worlds-section"><span class="std std-ref">Lab 6: 3D worlds</span></a> that we can use transformations to map coordinates and vectors between the model, view and screen spaces. The normal vectors in a normal map are defined in <strong>tangent space</strong>, a local coordinate system aligned with the surface that has the basis vectors:</p>
<ul class="simple">
<li><p><strong>Normal</strong>, <span class="math notranslate nohighlight">\(\vec{N}\)</span> - we have already met the normal vector which is a vector perpendicular to the surface.</p></li>
<li><p><strong>Tangent</strong>, <span class="math notranslate nohighlight">\(\vec{T}\)</span> - this is a vector that points in the direction of increasing texture coordinate <span class="math notranslate nohighlight">\(u\)</span>.</p></li>
<li><p><strong>Bitangent</strong>, <span class="math notranslate nohighlight">\(\vec{B}\)</span> - this is a vector that points in the direction of increasing texture coordinate <span class="math notranslate nohighlight">\(v\)</span>.</p></li>
</ul>
<figure class="align-default" id="tbn-figure">
<a class="reference internal image-reference" href="../_images/09_TBN.svg"><img alt="../_images/09_TBN.svg" src="../_images/09_TBN.svg" style="width: 250px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 98 </span><span class="caption-text">The tangent space is defined by the tangent, bitangent and normal vectors.</span><a class="headerlink" href="#tbn-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The world space tangent vector <span class="math notranslate nohighlight">\(\vec{T}\)</span> is calculated using the model space vertex coordinates of the triangle <span class="math notranslate nohighlight">\((x_0,y_0,z_0)\)</span>, <span class="math notranslate nohighlight">\((x_1,y_1,z_1)\)</span> and <span class="math notranslate nohighlight">\((x_2,y_2,z_2)\)</span> and their corresponding texture coordinates <span class="math notranslate nohighlight">\((u_0,v_0)\)</span>, <span class="math notranslate nohighlight">\((u_1,v_1)\)</span> and <span class="math notranslate nohighlight">\((u_2,v_2)\)</span>.</p>
<figure class="align-default" id="uv-deltas-figure">
<a class="reference internal image-reference" href="../_images/09_UV_deltas.svg"><img alt="../_images/09_UV_deltas.svg" src="../_images/09_UV_deltas.svg" style="width: 800px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 99 </span><span class="caption-text">The tangent, <span class="math notranslate nohighlight">\(\vec{T}\)</span>, and bitangent, <span class="math notranslate nohighlight">\(\vec{B}\)</span>, vectors are calculated by mapping the model space triangle onto the normal map space.</span><a class="headerlink" href="#uv-deltas-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>We first calculate vectors that point along two sides of the triangle in the model space</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    \vec{e}_1 &amp;= (x_1, y_1, z_1) - (x_0, y_0, z_0), \\
    \vec{e}_2 &amp;= (x_2, y_2, z_2) - (x_1, y_1, z_1),
\end{align*}\end{split}\]</div>
<p>and calculate the difference in the <span class="math notranslate nohighlight">\((u,v)\)</span> coordinates for these edges</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    \Delta u_1 &amp;= u_1 - u_0, &amp;
    \Delta v_1 &amp;= v_1 - v_0, \\
    \Delta u_2 &amp;= u_2 - u_1, &amp;
    \Delta v_2 &amp;= v_2 - v_1.
\end{align*} \end{split}\]</div>
<p>The tangent vector is then calculated using</p>
<div class="math notranslate nohighlight" id="equation-eq-tangent">
<span class="eqno">(25)<a class="headerlink" href="#equation-eq-tangent" title="Link to this equation">#</a></span>\[ \begin{align*}
    \vec{T} &amp;= \frac{\Delta v_2 \cdot \vec{e}_1 - \Delta v_1 \cdot \vec{e}_2}{\Delta u_1\Delta v_2 - \Delta u_2\Delta v_1}.
\end{align*} \]</div>
<p>To see the derivation of these equations click on the dropdown below.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Calculating the tangent and bitangent vectors</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Consider <a class="reference internal" href="#uv-deltas-figure"><span class="std std-numref">Fig. 99</span></a> where a triangle is mapped onto the normal map using texture coordinates <span class="math notranslate nohighlight">\((u_0,v_0)\)</span>, <span class="math notranslate nohighlight">\((u_1,v_1)\)</span> and <span class="math notranslate nohighlight">\((u_2,v_2)\)</span>. If the vectors <span class="math notranslate nohighlight">\(\vec{T}\)</span> and <span class="math notranslate nohighlight">\(\vec{B}\)</span> point in the <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span> co-ordinate directions then the tangent space coordinates of points along the triangle edges <span class="math notranslate nohighlight">\(\vec{e}_1\)</span> and <span class="math notranslate nohighlight">\(\vec{e}_2\)</span> can be calculated using</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
    \vec{e}_1 &amp;= \Delta u_1 \cdot \vec{T} + \Delta v_1 \cdot \vec{B}, \\
    \vec{e}_2 &amp;= \Delta u_2 \cdot \vec{T} + \Delta v_2 \cdot \vec{B},
\end{align*}\end{split}\]</div>
<p class="sd-card-text">where <span class="math notranslate nohighlight">\(\Delta u_1 = u_1 - u_0\)</span>, <span class="math notranslate nohighlight">\(\Delta v_1 = v_1 - v_0\)</span>, <span class="math notranslate nohighlight">\(\Delta u_2 = u_2 - u_1\)</span> and <span class="math notranslate nohighlight">\(\Delta v_2 = v_2 - v_1\)</span>. We can express this using matrices</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    \begin{pmatrix} \vec{e}_1 \\ \vec{e}_2 \end{pmatrix} &amp;=
    \begin{pmatrix}
        \Delta u_1 &amp; \Delta v_1 \\
        \Delta u_2 &amp; \Delta v_2
    \end{pmatrix}
  \begin{pmatrix} \vec{T} \\ \vec{B} \end{pmatrix}.
\end{align*} \end{split}\]</div>
<p class="sd-card-text">We want to calculate <span class="math notranslate nohighlight">\(\vec{T}\)</span> and <span class="math notranslate nohighlight">\(\vec{B}\)</span> and we know the values of <span class="math notranslate nohighlight">\(\vec{e}_1\)</span>, <span class="math notranslate nohighlight">\(\vec{e}_2\)</span>, <span class="math notranslate nohighlight">\(\Delta u_1\)</span>, <span class="math notranslate nohighlight">\(\Delta v_1\)</span>, <span class="math notranslate nohighlight">\(\Delta u_2\)</span> and <span class="math notranslate nohighlight">\(\Delta v_2\)</span>. Using the <a class="reference internal" href="#inverse-matrix-section"><span class="xref myst">inverse</span></a> of the square matrix we can rewrite this equation as</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align*}
    \begin{pmatrix} \vec{T} \\ \vec{B} \end{pmatrix} &amp;=
    \begin{pmatrix}
        \Delta u_1 &amp; \Delta v_1 \\
        \Delta u_2 &amp; \Delta v_2
    \end{pmatrix}^{-1}
    \begin{pmatrix} \vec{e}_1 \\ \vec{e}_2 \end{pmatrix} \\
    &amp;= \frac{1}{\Delta u_1\Delta v_2 - \Delta u_2\Delta v_1}
    \begin{pmatrix}
        \Delta v_2 &amp; -\Delta v_1 \\
        -\Delta u_2 &amp; \Delta u_1
    \end{pmatrix}
    \begin{pmatrix} \vec{e}_1 \\ \vec{e}_2 \end{pmatrix}.
\end{align*} \end{split}\]</div>
<p class="sd-card-text">Writing the out for the <span class="math notranslate nohighlight">\(\vec{T}\)</span> vector we have</p>
<div class="math notranslate nohighlight">
\[ \begin{align*}
    \vec{T} &amp;= \frac{\Delta v_2 \cdot \vec{e}_1 - \Delta v_1 \cdot \vec{e}_2}{\Delta u_1\Delta v_2 - \Delta u_2\Delta v_1}.
\end{align*} \]</div>
</div>
</details><p>Since the bitangent vector <span class="math notranslate nohighlight">\(\vec{B}\)</span> is perpendicular to the normal vector <span class="math notranslate nohighlight">\(\vec{N}\)</span> and the tangent vector <span class="math notranslate nohighlight">\(\vec{T}\)</span> we can calculate this using</p>
<div class="math notranslate nohighlight">
\[ \vec{B} = \vec{N} \times \vec{T}. \]</div>
<p>Once we have the tangent, bitangent and normal vectors we can form a matrix that transforms from the tangent space to the world space. The matrix that achieves this a 3 <span class="math notranslate nohighlight">\(\times\)</span> 3 matrix known as the <span class="math notranslate nohighlight">\(TBN\)</span> matrix</p>
<div class="math notranslate nohighlight" id="equation-eq-tbn-matrix">
<span class="eqno">(26)<a class="headerlink" href="#equation-eq-tbn-matrix" title="Link to this equation">#</a></span>\[\begin{split} \begin{align*}
    TBN &amp;= 
    \begin{pmatrix}
        \vec{T}_x &amp; \vec{B}_x &amp; \vec{N}_x \\
        \vec{T}_y &amp; \vec{B}_y &amp; \vec{N}_y \\
        \vec{T}_z &amp; \vec{B}_z &amp; \vec{N}_z
    \end{pmatrix},
\end{align*} \end{split}\]</div>
<section id="calculating-the-tangent-vectors">
<h3>Calculating the tangent vectors<a class="headerlink" href="#calculating-the-tangent-vectors" title="Link to this heading">#</a></h3>
<p>All the lighting calculations are performed by the shaders, so we calculate the tangent vectors in JavaScript and pass them to the shaders using uniforms.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following function to the <em><strong>webGLUtils.js</strong></em> file.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">computeTangents</span><span class="p">(</span><span class="nx">vertices</span><span class="p">,</span><span class="w"> </span><span class="nx">indices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">vertexCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">indices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tangents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Float32Array</span><span class="p">(</span><span class="mf">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">vertexCount</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">vertexCount</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// Indices of triangle vertices</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">i0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">i2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">indices</span><span class="p">[</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// Positions and uvs</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p0x</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p0y</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p0z</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p1x</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p1y</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p1z</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p2x</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p2y</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">p2z</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">];</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uv0x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">6</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uv0y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">7</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uv1x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">6</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uv1y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">7</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uv2x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">6</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uv2y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">7</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// Edges</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">e1x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">p1x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">p0x</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">e1y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">p1y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">p0y</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">e1z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">p1z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">p0z</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">e2x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">p2x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">p1x</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">e2y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">p2y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">p1y</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">e2z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">p2z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">p1z</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// UV deltas</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">du1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uv1x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">uv0x</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uv1y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">uv0y</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">du2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uv2x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">uv1x</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uv2y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">uv1y</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Calculate tangent and bitangent</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">denom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">du1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">dv2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">du2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">dv1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">denom</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">denom</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">dv2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">e1x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">dv1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">e2x</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">dv2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">e1y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">dv1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">e2y</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">dv2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">e1z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">dv1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">e2z</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Accumulate tangents</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="p">[</span><span class="nx">i0</span><span class="p">,</span><span class="w"> </span><span class="nx">i1</span><span class="p">,</span><span class="w"> </span><span class="nx">i2</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">tangents</span><span class="p">[</span><span class="nx">idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0</span><span class="p">]</span><span class="w">   </span><span class="o">+=</span><span class="w"> </span><span class="nx">tx</span><span class="p">;</span>
<span class="w">      </span><span class="nx">tangents</span><span class="p">[</span><span class="nx">idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="w">   </span><span class="o">+=</span><span class="w"> </span><span class="nx">ty</span><span class="p">;</span>
<span class="w">      </span><span class="nx">tangents</span><span class="p">[</span><span class="nx">idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">]</span><span class="w">   </span><span class="o">+=</span><span class="w"> </span><span class="nx">tz</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">tangents</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then, add the following to the <code class="docutils literal notranslate"><span class="pre">createVao()</span></code> function before we unbind the VAO.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Tangents</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">tangents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">computeTangents</span><span class="p">(</span><span class="nx">vertices</span><span class="p">,</span><span class="w"> </span><span class="nx">indices</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">tangentLocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gl</span><span class="p">.</span><span class="nx">getAttribLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;aTangent&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">tangentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>

<span class="nx">gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span><span class="w"> </span><span class="nx">tangentBuffer</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span><span class="w"> </span><span class="nx">tangents</span><span class="p">,</span><span class="w"> </span><span class="nx">gl</span><span class="p">.</span><span class="nx">STATIC_DRAW</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span><span class="nx">tangentLocation</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span><span class="nx">tangentLocation</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="nx">gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Here we have written a function to compute the tangent vectors in the model space using equation <a class="reference internal" href="#equation-eq-tangent">(25)</a>, created a buffer for the tangents and sent it to the GPU simiarly to what we did for the vertex coordinates, texture coordinates and normal vectors.</p>
</section>
</section>
<hr class="docutils" />
<section id="shaders">
<h2>Shaders<a class="headerlink" href="#shaders" title="Link to this heading">#</a></h2>
<p>In the vertex shader we need to calculate the world space tangent vector for the vertex and output this to the fragment shader.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add input and output declarations to the vertex shader in the <em><strong>normal_mapping.js</strong></em> file.</p>
<div class="highlight-glsl notranslate"><div class="highlight"><pre><span></span><span class="k">in</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">aTangent</span><span class="p">;</span>


<span class="k">out</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">vTangent</span><span class="p">;</span>
</pre></div>
</div>
<p>Then add the following to the <code class="docutils literal notranslate"><span class="pre">main()</span></code> function</p>
<div class="highlight-glsl notranslate"><div class="highlight"><pre><span></span><span class="c1">// Output world space tangent vector</span>
<span class="n">vTangent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="kt">mat3</span><span class="p">(</span><span class="n">uModel</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">aTangent</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Here we transform the tangent to the world space using the model matrix and output it to the fragment shader. Now we need to edit the fragment shader to calculate the <span class="math notranslate nohighlight">\(TBN\)</span> matrix using equation <a class="reference internal" href="#equation-eq-tbn-matrix">(26)</a> and use it to transform the normal vectors from the normal map from the tangent space to the world space.</p>
<p>The values in a texture are between 0 and 1, and we need the values of a normal vector to be between -1 and 1. So to convert the normal map colours to a normal vector we use the following</p>
<div class="math notranslate nohighlight">
\[ \vec{n}_{tangent} = 2 \times \vec{n}_{map} - 1. \]</div>
<p>which is then transformed to the world space using</p>
<div class="math notranslate nohighlight">
\[ \vec{n}_{world} = TBN \cdot \vec{n}_{tangent}. \]</div>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following input declaration to the fragment shader.</p>
<div class="highlight-glsl notranslate"><div class="highlight"><pre><span></span><span class="k">in</span><span class="w"> </span><span class="kt">vec3</span><span class="w"> </span><span class="n">vTangent</span><span class="p">;</span>
</pre></div>
</div>
<p>And add the uniform for the normal map.</p>
<div class="highlight-glsl notranslate"><div class="highlight"><pre><span></span><span class="k">uniform</span><span class="w"> </span><span class="kt">sampler2D</span><span class="w"> </span><span class="n">uNormalMap</span><span class="p">;</span>
</pre></div>
</div>
<p>Then in the <code class="docutils literal notranslate"><span class="pre">main()</span></code> function, add the following before we calculate the lighting for each light source</p>
<div class="highlight-glsl notranslate"><div class="highlight"><pre><span></span><span class="c1">// Construct tangent space basis</span>
<span class="kt">vec3</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">vTangent</span><span class="p">);</span>
<span class="kt">vec3</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cross</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">);</span>
<span class="kt">mat3</span><span class="w"> </span><span class="n">TBN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">mat3</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>

<span class="c1">// Calculate world space normal</span>
<span class="kt">vec3</span><span class="w"> </span><span class="n">normalSample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">texture</span><span class="p">(</span><span class="n">uNormalMap</span><span class="p">,</span><span class="w"> </span><span class="n">vTexCoords</span><span class="p">).</span><span class="n">rgb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normalize</span><span class="p">(</span><span class="n">TBN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">normalSample</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Refresh your web browser and move the camera around to see the effects of the normal map.</p>
<figure class="align-default" id="id3">
<a class="reference internal image-reference" href="../_images/09_cubes_specular_1.png"><img alt="../_images/09_cubes_specular_1.png" src="../_images/09_cubes_specular_1.png" style="width: 80%;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 100 </span><span class="caption-text">The crate specular map applied to the cubes.</span><a class="headerlink" href="#id3" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The lighting properties of our cubes makes the surfaces look shiny. Since these should be wooden, we can reduce the specular coefficient to give a more realistic result.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Change the <code class="docutils literal notranslate"><span class="pre">ks</span></code> attribute of the cube objects to the following.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">ks</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span>
</pre></div>
</div>
</div>
<p>Refresh your web browser and you should see that the cubes are now less shiny and more realistic.</p>
<figure class="align-default" id="id4">
<a class="reference internal image-reference" href="../_images/09_cubes_specular_2.png"><img alt="../_images/09_cubes_specular_2.png" src="../_images/09_cubes_specular_2.png" style="width: 80%;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 101 </span><span class="caption-text">The crate specular map applied to the cubes (<span class="math notranslate nohighlight">\(k_s = 0.2\)</span>).</span><a class="headerlink" href="#id4" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<hr class="docutils" />
<section id="specular-maps">
<h2>Specular maps<a class="headerlink" href="#specular-maps" title="Link to this heading">#</a></h2>
<p>In addition to diffuse (texture) and normal maps we can also apply a <strong>specular map</strong> which can be used to control the specular highlights across a surface. Lets say we want to add a stone floor to our scene. We can add a horizontal polygon object for the floor and use a texture map <a class="reference internal" href="#stones-diffuse-map-figure"><span class="std std-numref">Fig. 102</span></a> to give the impression of stones and a normal map <a class="reference internal" href="#stones-normal-map-figure"><span class="std std-numref">Fig. 103</span></a> so that the stones are lit by the light sources.</p>
<div class="sd-container-fluid sd-sphinx-override sd-mb-4 docutils">
<div class="sd-row docutils">
<div class="sd-col sd-d-flex-column docutils">
<figure class="align-default" id="stones-diffuse-map-figure">
<img alt="../_images/09_stones_diffuse.png" src="../_images/09_stones_diffuse.png" />
<figcaption>
<p><span class="caption-number">Fig. 102 </span><span class="caption-text">Diffuse map</span><a class="headerlink" href="#stones-diffuse-map-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
</div>
<div class="sd-col sd-d-flex-column docutils">
<figure class="align-default" id="stones-normal-map-figure">
<img alt="../_images/09_stones_normal.png" src="../_images/09_stones_normal.png" />
<figcaption>
<p><span class="caption-number">Fig. 103 </span><span class="caption-text">Normal map</span><a class="headerlink" href="#stones-normal-map-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
</div>
<div class="sd-col sd-d-flex-column docutils">
<figure class="align-default" id="stones-specular-map-figure">
<img alt="../_images/09_stones_specular.png" src="../_images/09_stones_specular.png" />
<figcaption>
<p><span class="caption-number">Fig. 104 </span><span class="caption-text">Specular map</span><a class="headerlink" href="#stones-specular-map-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
</div>
<p>To add our stone floor we are going to load in a simple 2D plane model, add diffuse and normal textures, define lighting and world space properties and draw it.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Add the following code after we load the crate textures.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Define floor vertices</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">floorVertices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Float32Array</span><span class="p">([</span>
<span class="w">  </span><span class="c1">// x  y   z      r  g  b     u  v     nx  ny  nz</span>
<span class="w">   </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w">  </span><span class="mf">0</span><span class="p">,</span><span class="w">  </span><span class="mf">1</span><span class="p">,</span><span class="w">     </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">    </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">    </span><span class="mf">0</span><span class="p">,</span><span class="w">  </span><span class="mf">1</span><span class="p">,</span><span class="w">  </span><span class="mf">0</span><span class="p">,</span>
<span class="w">    </span><span class="mf">1</span><span class="p">,</span><span class="w">  </span><span class="mf">0</span><span class="p">,</span><span class="w">  </span><span class="mf">1</span><span class="p">,</span><span class="w">     </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">    </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">    </span><span class="mf">0</span><span class="p">,</span><span class="w">  </span><span class="mf">1</span><span class="p">,</span><span class="w">  </span><span class="mf">0</span><span class="p">,</span>
<span class="w">    </span><span class="mf">1</span><span class="p">,</span><span class="w">  </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w">     </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">    </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w">    </span><span class="mf">0</span><span class="p">,</span><span class="w">  </span><span class="mf">1</span><span class="p">,</span><span class="w">  </span><span class="mf">0</span><span class="p">,</span>
<span class="w">   </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w">  </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w">     </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">    </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w">    </span><span class="mf">0</span><span class="p">,</span><span class="w">  </span><span class="mf">1</span><span class="p">,</span><span class="w">  </span><span class="mf">0</span><span class="p">,</span>
<span class="p">]);</span>

<span class="c1">// Define floor indices</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">floorIndices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint16Array</span><span class="p">([</span>
<span class="w">   </span><span class="mf">0</span><span class="p">,</span><span class="w">  </span><span class="mf">1</span><span class="p">,</span><span class="w">  </span><span class="mf">2</span><span class="p">,</span><span class="w">  </span>
<span class="w">   </span><span class="mf">0</span><span class="p">,</span><span class="w">  </span><span class="mf">2</span><span class="p">,</span><span class="w">  </span><span class="mf">3</span><span class="p">,</span>
<span class="p">]);</span>

<span class="c1">// Define floor VAO</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">floorVao</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createVao</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span><span class="w"> </span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="nx">floorVertices</span><span class="p">,</span><span class="w"> </span><span class="nx">floorIndices</span><span class="p">);</span>

<span class="c1">// Load floor textures</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">floorTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">loadTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;assets/stones.png&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">floorNormalMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">loadTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;assets/stones_normal.png&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>And add the following after we have drawn the cubes.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Draw floor</span>
<span class="c1">// Bind texture</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE0</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span><span class="w"> </span><span class="nx">floorTexture</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uTexture&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="c1">// Bind normal map</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE1</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span><span class="w"> </span><span class="nx">floorNormalMap</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uNormalMap&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>

<span class="c1">// Bind specular map</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE2</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span><span class="w"> </span><span class="nx">floorSpecularMap</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uSpecularMap&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>

<span class="c1">// Send object light properties to the shader</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1f</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uKa&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1f</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uKd&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">0.7</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1f</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uKs&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1f</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uShininess&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">32</span><span class="p">);</span>

<span class="c1">// Calculate the model matrix</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Mat4</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="nx">translate</span><span class="p">([</span><span class="mf">6</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">6</span><span class="p">])</span>
<span class="w">  </span><span class="p">.</span><span class="nx">scale</span><span class="p">([</span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">]);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uModel&quot;</span><span class="p">),</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">m</span><span class="p">);</span>

<span class="c1">// Draw the triangles</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">bindVertexArray</span><span class="p">(</span><span class="nx">floorVao</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">drawElements</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TRIANGLES</span><span class="p">,</span><span class="w"> </span><span class="nx">floorIndices</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">gl</span><span class="p">.</span><span class="nx">UNSIGNED_SHORT</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Here we have added another object ot our scene that consists of a simple flat plane which has been scaled up and translated so that it forms a floor underneath the cubes. All of the this code is similar to what we have done previously. Refresh your web browser and move the camera around to see the effect of normal mapping on the stone floor.</p>
<figure class="align-default" id="id5">
<a class="reference internal image-reference" href="../_images/09_floor_no_specular.png"><img alt="../_images/09_floor_no_specular.png" src="../_images/09_floor_no_specular.png" style="width: 80%;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 105 </span><span class="caption-text">A the floor object with normal mapping.</span><a class="headerlink" href="#id5" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Note how the mortar between the stones have specular highlights. This isn’t very realistic as in real life mortar is rough and does not appear shiny. To overcome this we can apply a specular map (<a class="reference internal" href="#stones-specular-map-figure"><span class="std std-numref">Fig. 104</span></a>) to switch off the specular highlights for certain fragments.</p>
<div class="tip admonition">
<p class="admonition-title">Task</p>
<p>Download the file <a class="reference download internal" download="" href="../_downloads/7c1b1843464cce3e2914d585045de372/crate_specular.png"><span class="xref download myst">stones_specular.png</span></a> and save it in your <em><strong>Lab 9 - Normal Mapping/assets/</strong></em> folder.</p>
<p>Add the following code after we have loaded the floor textures.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">floorSpecularMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">loadTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;assets/stones_specular.png&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>And add the following after we bind the normal map for the floor.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Bind specular map</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">activeTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE2</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">bindTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TEXTURE_2D</span><span class="p">,</span><span class="w"> </span><span class="nx">floorSpecularMap</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">uniform1i</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;uSpecularMap&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
</pre></div>
</div>
<p>Then in the fragment shader, add a declaration for the specular map</p>
<div class="highlight-glsl notranslate"><div class="highlight"><pre><span></span><span class="k">uniform</span><span class="w"> </span><span class="kt">sampler2D</span><span class="w"> </span><span class="n">uSpecularMap</span><span class="p">;</span>
</pre></div>
</div>
<p>And add the following after the specular lighting is calculated.</p>
<div class="highlight-glsl notranslate"><div class="highlight"><pre><span></span><span class="n">specular</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">texture</span><span class="p">(</span><span class="n">uSpecularMap</span><span class="p">,</span><span class="w"> </span><span class="n">vTexCoords</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Refresh your web browser and position the camera to see the effect of the specular map. Note how the mortar between the stones no longer appears to be shiny.</p>
<figure class="align-default" id="id6">
<a class="reference internal image-reference" href="../_images/09_floor_specular.png"><img alt="../_images/09_floor_specular.png" src="../_images/09_floor_specular.png" style="width: 80%;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 106 </span><span class="caption-text">A the floor object with normal and specular mapping.</span><a class="headerlink" href="#id6" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<hr class="docutils" />
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Add another object using the .obj model <strong>../assets/wall.obj</strong> to your scene and position it at <span class="math notranslate nohighlight">\((0, 4, -5)\)</span>, scale it up by a factor of 5 in the <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(z\)</span> directions and rotate it <span class="math notranslate nohighlight">\(90^\circ\)</span> about the <span class="math notranslate nohighlight">\(x\)</span>-axis. Apply the diffuse map <strong>assets/bricks_diffuse.png</strong>.</p></li>
</ol>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/09_ex1.png"><img alt="_images/09_ex1.png" src="_images/09_ex1.png" style="width: 500px;" />
</a>
</figure>
<ol class="arabic simple" start="2">
<li><p>Apply the normal map <strong>assets/bricks_normal.png</strong> to the wall object.</p></li>
</ol>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/09_ex2.png"><img alt="_images/09_ex2.png" src="_images/09_ex2.png" style="width: 500px;" />
</a>
</figure>
<ol class="arabic simple" start="3">
<li><p>Apply the specular map <strong>assets/bricks_specular.png</strong> to the wall object.</p></li>
</ol>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/09_ex3.png"><img alt="_images/09_ex3.png" src="_images/09_ex3.png" style="width: 500px;" />
</a>
</figure>
</section>
<hr class="docutils" />
<section id="video-walkthrough">
<h2>Video walkthrough<a class="headerlink" href="#video-walkthrough" title="Link to this heading">#</a></h2>
<p>The video below walks you through these lab materials.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./_pages"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="08_Lighting.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lab 8: Lighting</p>
      </div>
    </a>
    <a class="right-next"
       href="10_Quaternions.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lab 10: Quaternions</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tangent-space">Tangent space</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-the-tangent-vectors">Calculating the tangent vectors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#shaders">Shaders</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#specular-maps">Specular maps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#video-walkthrough">Video walkthrough</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dr Jon Shiach
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>